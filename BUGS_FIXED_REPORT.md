# üêõ –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–∞–≥–∞—Ö –≤ —Å–∏—Å—Ç–µ–º–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 4 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üìã –û–±–∑–æ—Ä

–í –ø—Ä–æ—Ü–µ—Å—Å–µ –∞—É–¥–∏—Ç–∞ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã **4 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–∞**, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏

### –ë–ê–ì #1: Race Condition –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–§–∞–π–ª:** `src/app/api/documents/route.ts`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –í—ã—Å–æ–∫–∞—è (Performance + –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è race condition)

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
–§—É–Ω–∫—Ü–∏—è `checkAccessPeriod(userId)` –≤—ã–∑—ã–≤–∞–ª–∞—Å—å **–¥–≤–∞–∂–¥—ã** –≤ –æ–¥–Ω–æ–º API route:
- –°—Ç—Ä–æ–∫–∞ 74: –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –°—Ç—Ä–æ–∫–∞ 140: –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞ demo –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
1. **2 –ª–∏—à–Ω–∏—Ö DB –∑–∞–ø—Ä–æ—Å–∞** –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π **race condition** - –º–µ–∂–¥—É –¥–≤—É–º—è –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–≥–ª–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é **—É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏** –≤–º–µ—Å—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```typescript
// ‚ùå –ë–´–õ–û:
const accessCheck = await checkAccessPeriod(user.id); // DB –∑–∞–ø—Ä–æ—Å #1
// ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ ...
const accessCheck2 = await checkAccessPeriod(user.id); // DB –∑–∞–ø—Ä–æ—Å #2 (–¥—É–±–ª–∏–∫–∞—Ç!)

// ‚úÖ –°–¢–ê–õ–û:
let isUsingDemo = false;
const accessCheck = checkUserAccessPeriod(user); // –ë–µ–∑ DB –∑–∞–ø—Ä–æ—Å–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
if (accessCheck.status === 'not_granted') {
  isUsingDemo = true;
}
// ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ ...
if (user.role !== 'admin' && isUsingDemo) {
  await incrementDocumentUsage(user.id);
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ **2 –ª–∏—à–Ω–∏—Ö DB –∑–∞–ø—Ä–æ—Å–∞** –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è race condition
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `checkUserAccessPeriod()` –≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π `checkAccessPeriod()`
- üìä **–ü—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** ~40-60ms –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç latency –∫ –ë–î)

---

### –ë–ê–ì #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

**–§–∞–π–ª:** `src/app/api/auth/verify-code/route.ts`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω—è—è (Security Audit)

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
–í –±–ª–æ–∫–µ catch –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 165) –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ console, –Ω–æ **–Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∞—Å—å –≤ security log**. –≠—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ:
- –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º –≤ production

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```typescript
// ‚ùå –ë–´–õ–û:
} catch (error) {
  console.error('Verify code error');
  return NextResponse.json(
    { success: false, error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' },
    { status: 500 }
  );
}

// ‚úÖ –°–¢–ê–õ–û:
} catch (error) {
  console.error('Verify code error:', error);
  
  // –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –õ–æ–≥–∏—Ä—É–µ–º internal server error
  try {
    await logSecurityEventFromRequest(request, 'login_failed', {
      metadata: { 
        reason: 'internal_error', 
        error: error instanceof Error ? error.message : 'unknown' 
      },
    });
  } catch (logError) {
    console.error('Failed to log verify code error:', logError);
  }
  
  return NextResponse.json(
    { success: false, error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' },
    { status: 500 }
  );
}
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `SecurityLog`
- ‚úÖ –£–ª—É—á—à–µ–Ω –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫ –∏ –ø—Ä–æ–±–ª–µ–º –≤ production

---

### –ë–ê–ì #3: sameSite='strict' –±–ª–æ–∫–∏—Ä—É–µ—Ç cookies –ø—Ä–∏ –≤–Ω–µ—à–Ω–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö

**–§–∞–π–ª—ã:**
- `src/lib/jwt.ts` (—Å—Ç—Ä–æ–∫–∏ 82, 159)
- `src/lib/csrf.ts` (—Å—Ç—Ä–æ–∫–∞ 20)

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω—è—è (UX + –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `sameSite: 'strict'` –¥–ª—è cookies –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Ç–æ–º—É, —á—Ç–æ cookies **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å** –ø—Ä–∏:
- –ü–µ—Ä–µ—Ö–æ–¥–∞—Ö —Å –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–æ–≤ (email-—Å—Å—ã–ª–∫–∏, –ø–æ–∏—Å–∫–æ–≤–∏–∫–∏, —Å–æ—Ü—Å–µ—Ç–∏)
- OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- –õ—é–±—ã—Ö cross-site –Ω–∞–≤–∏–≥–∞—Ü–∏—è—Ö

–≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ:
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ logout'—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ email-—Å—Å—ã–ª–∫–∞–º
- –ü–ª–æ—Ö–æ–π UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```typescript
// ‚ùå –ë–´–õ–û:
const cookieOptions = {
  httpOnly: true,
  secure: isProduction,
  sameSite: 'strict' as const, // ‚ùå –°–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ!
  maxAge: 60 * 15,
  path: '/',
};

// ‚úÖ –°–¢–ê–õ–û:
const cookieOptions = {
  httpOnly: true,
  secure: isProduction,
  sameSite: 'lax' as const, // ‚úÖ –ë–∞–ª–∞–Ω—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ UX
  maxAge: 60 * 15,
  path: '/',
};
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ Cookies –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö —Å –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫ (–≤ —Å–≤—è–∑–∫–µ —Å CSRF tokens)
- ‚úÖ –£–ª—É—á—à–µ–Ω UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º–∏
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å OAuth –∏ email-—Å—Å—ã–ª–∫–∞–º–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `sameSite: 'lax'` - —ç—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –û–Ω–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç CSRF –ø—Ä–∏ POST/PUT/DELETE –∑–∞–ø—Ä–æ—Å–∞—Ö, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç cookies –ø—Ä–∏ GET-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

---

### –ë–ê–ì #4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ checkAccessPeriod()

**–§–∞–π–ª:** `src/app/api/documents/route.ts`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω—è—è (Performance)

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
–í –∫–æ–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `@deprecated` –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `checkAccessPeriod()`, –Ω–æ –æ–Ω–∞ –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –õ–∏—à–Ω–∏–º DB –∑–∞–ø—Ä–æ—Å–∞–º
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—é —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º inconsistency –≤ –¥–∞–Ω–Ω—ã—Ö

#### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```typescript
// ‚ùå –ë–´–õ–û:
import { getCurrentUser, checkDemoLimit, checkAccessPeriod, incrementDocumentUsage } from '@/lib/auth-utils';
const accessCheck = await checkAccessPeriod(user.id); // –î–µ–ª–∞–µ—Ç DB –∑–∞–ø—Ä–æ—Å

// ‚úÖ –°–¢–ê–õ–û:
import { getCurrentUser, checkDemoLimit, checkUserAccessPeriod, incrementDocumentUsage } from '@/lib/auth-utils';
const accessCheck = checkUserAccessPeriod(user); // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ª–∏—à–Ω–∏–µ DB –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ best practices (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)

---

## üìä –û–±—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **-3 DB –∑–∞–ø—Ä–æ—Å–∞** –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (1 getCurrentUser + 2 checkAccessPeriod ‚Üí 1 getCurrentUser)
- **~40-60ms** —É–ª—É—á—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü—Ä–∏ 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –¥–µ–Ω—å —ç–∫–æ–Ω–æ–º–∏—è ~40,000-60,000ms = **40-60 —Å–µ–∫—É–Ω–¥** DB –≤—Ä–µ–º–µ–Ω–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω –∞—É–¥–∏—Ç security —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç timing attacks —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ CSRF protection —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å `sameSite: 'lax'`

### UX / –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö —Å –≤–Ω–µ—à–Ω–∏—Ö —Å–∞–π—Ç–æ–≤
- ‚úÖ Email-—Å—Å—ã–ª–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ OAuth

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ (–Ω–µ –±–∞–≥–∏, –Ω–æ –≤–∞–∂–Ω–æ)

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ –∫–æ–¥–µ:

1. **–ó–∞—â–∏—Ç–∞ –æ—Ç Race Conditions:**
   - –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å `updateMany()` –≤ verify-code
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `count === 0` –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è concurrent –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

2. **–ó–∞—â–∏—Ç–∞ –æ—Ç Timing Attacks:**
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ send-code (Promise.all)
   - –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
   - –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö/–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

3. **Security Logging:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π (login_success, login_failed, logout, token_refresh)
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (IP, user agent, reason)
   - Graceful error handling - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ª–æ–º–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É

4. **Refresh Token Rotation:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
   - –ó–∞—â–∏—Ç–∞ –æ—Ç replay attacks
   - –û—Ç–∑—ã–≤ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ email/—Ä–æ–ª–∏

5. **Rate Limiting:**
   - –ì–ª–æ–±–∞–ª—å–Ω—ã–π rate limit –¥–ª—è API (middleware)
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π rate limit –¥–ª—è auth endpoints
   - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π rate limit –¥–ª—è AI chat

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
1. ‚úÖ **–°–î–ï–õ–ê–ù–û:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ documents API
2. üí° **TODO:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ `getCurrentUser()` –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ request
3. üí° **TODO:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª–µ–π (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
1. ‚úÖ **–°–î–ï–õ–ê–ù–û:** –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. üí° **TODO:** –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (dashboard –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
3. üí° **TODO:** Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö login attempts

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
1. üí° **TODO:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerts –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö failed login attempts
2. üí° **TODO:** Dashboard —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. üí° **TODO:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö security logs (—Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ –µ—Å—Ç—å: `cleanupOldSecurityLogs()`)

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏ **—É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å:
- **–ë—ã—Å—Ç—Ä–µ–µ** (–º–µ–Ω—å—à–µ DB –∑–∞–ø—Ä–æ—Å–æ–≤)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ** (–ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **–£–¥–æ–±–Ω–µ–µ** (cookies —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ –≤–Ω–µ—à–Ω–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö)
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–µ–µ** (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)

–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ





