# üìä –¢–û–¢–ê–õ–¨–ù–´–ô –ê–£–î–ò–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–ò –ü–†–û–ï–ö–¢–ê

**–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–µ–∫—Ç:** –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ (Next.js 15 + Prisma)  
**–ê—É–¥–∏—Ç–æ—Ä:** Senior Full-Stack Engineer & System Analyst  
**–ú–µ—Ç–æ–¥:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

---

## üéØ –†–ï–ó–Æ–ú–ï

**–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:** ‚úÖ **Production-Ready** —Å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 8.5/10

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Next.js 15 App Router —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å JWT, rate limiting, Zod validation  
**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–∫—Ä—ã—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (10 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)

---

## üìã –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. üß© –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ç—É—Å | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|--------|-------------|
| **–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | ‚úÖ | 9/10 | –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è Next.js –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º: UI ‚Üí API Routes ‚Üí Services ‚Üí Prisma ‚Üí PostgreSQL |
| **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤** | ‚úÖ | 9/10 | –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: Pages (`/app`), API (`/app/api`), Business Logic (`/lib/auth-utils.ts`, `/lib/services`), Data Layer (Prisma), Validation (`/lib/schemas`) |
| **MVC –ø–∞—Ç—Ç–µ—Ä–Ω** | ‚úÖ | 8/10 | Controller = API Routes, Model = Prisma schemas, View = React components. –•–æ—Ä–æ—à–µ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ |
| **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** | ‚úÖ | 10/10 | –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–¥—É—Ç –æ–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ: Pages ‚Üí API ‚Üí Services ‚Üí Prisma |
| **DTO/Models** | ‚úÖ | 9/10 | –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: Prisma models (`schema.prisma`), Zod schemas (`/lib/schemas`), TypeScript types (`/lib/types`) |
| **SOLID –ø—Ä–∏–Ω—Ü–∏–ø—ã** | ‚úÖ | 8/10 | **SRP** ‚úÖ –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å<br>**OCP** ‚úÖ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–µ API routes<br>**LSP** ‚úÖ –Ω–µ—Ç —è–≤–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π<br>**ISP** ‚ö†Ô∏è –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ utils —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥–ª–∏ –±—ã –±—ã—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω—ã<br>**DIP** ‚úÖ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ Prisma |
| **DRY –ø—Ä–∏–Ω—Ü–∏–ø** | ‚ö†Ô∏è | 7/10 | –ï—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –≤ `generate-pdf.ts` –∏ `generate-docx.ts` (—Ñ—É–Ω–∫—Ü–∏—è `formatRequisiteLabel`) |
| **KISS –ø—Ä–∏–Ω—Ü–∏–ø** | ‚úÖ | 9/10 | –ö–æ–¥ –ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π, –Ω–µ—Ç overengineering |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –í—ã–Ω–µ—Å—Ç–∏ `formatRequisiteLabel` –≤ `/lib/utils/requisites.ts` –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ `/lib/auth-utils.ts` (550+ —Å—Ç—Ä–æ–∫) –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏: `auth`, `access`, `refresh-tokens`, `email-verification`

---

### 2. üîê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|--------|-------------|
| **JWT —Ç–æ–∫–µ–Ω—ã** | ‚úÖ | 9/10 | Access token (15 –º–∏–Ω) + Refresh token (7 –¥–Ω–µ–π). –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ HttpOnly cookies |
| **Access Token** | ‚úÖ | 9/10 | –ö–æ—Ä–æ—Ç–∫–∏–π TTL (15 –º–∏–Ω), –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ `jsonwebtoken` |
| **Refresh Token** | ‚úÖ | 10/10 | –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î, —Ä–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∑—ã–≤–∞ |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π** | ‚úÖ | 9/10 | Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å `admin` –¥–ª—è `/api/admin/*`. –í auth-utils –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `isAdmin()` |
| **–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** | ‚úÖ | 10/10 | JWT `exp` claim –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. Middleware –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã |
| **–û–±—Ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π** | ‚úÖ | 10/10 | –ó–∞—â–∏—Ç–∞ –Ω–∞ –¥–≤—É—Ö —É—Ä–æ–≤–Ω—è—Ö: middleware + getCurrentUser() –≤ –∫–∞–∂–¥–æ–º route. –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–æ–π—Ç–∏ |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤** | ‚úÖ | 10/10 | `JWT_SECRET` –∏–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. ‚ùå –ù–µ—Ç hardcode |
| **Email verification** | ‚úÖ | 9/10 | 6-digit –∫–æ–¥ —Å 10 –º–∏–Ω TTL. Timing attack protection. Rate limiting |
| **Refresh flow** | ‚úÖ | 10/10 | `/api/auth/refresh` —Å —Ä–æ—Ç–∞—Ü–∏–µ–π —Ç–æ–∫–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î + JWT signature. –û—Ç–∑—ã–≤ —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ |
| **–í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** | ‚úÖ | 10/10 | `accessFrom`/`accessUntil` –ø–æ–ª—è. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ middleware –∏ API. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| **Demo –ª–∏–º–∏—Ç—ã** | ‚úÖ | 9/10 | `DemoStatus` –º–æ–¥–µ–ª—å —Å `documentsUsed`/`documentsLimit`. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| **Logout** | ‚úÖ | 8/10 | –û—á–∏—Å—Ç–∫–∞ cookies. ‚ö†Ô∏è –ù–µ –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è refresh —Ç–æ–∫–µ–Ω—ã –≤ –ë–î –ø—Ä–∏ logout |
| **Session hijacking** | ‚úÖ | 9/10 | HttpOnly cookies, Secure flag –Ω–∞ production, SameSite=Lax |
| **CSRF –∑–∞—â–∏—Ç–∞** | ‚úÖ | 8/10 | SameSite cookies. ‚ö†Ô∏è –ù–µ—Ç —è–≤–Ω–æ–≥–æ CSRF —Ç–æ–∫–µ–Ω–∞, –Ω–æ –¥–ª—è API —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ |

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ü—Ä–∏ logout (`/api/auth/logout/route.ts`) –Ω–µ –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è refresh —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- ‚ö†Ô∏è **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í README —É–∫–∞–∑–∞–Ω SMS –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Auth4App, –Ω–æ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Email + –∫–æ–¥ (Nodemailer)
- ‚úÖ **Timing attacks:** –ó–∞—â–∏—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `/api/auth/send-code` —á–µ—Ä–µ–∑ –±–∞–∑–æ–≤—É—é –∑–∞–¥–µ—Ä–∂–∫—É 500ms

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
```typescript
// –í /api/auth/logout/route.ts –¥–æ–±–∞–≤–∏—Ç—å:
import { revokeAllUserRefreshTokens } from '@/lib/auth-utils';

const user = await getCurrentUser(request);
if (user) {
  await revokeAllUserRefreshTokens(user.id);
}
```

---

### 3. üì° API –ò –ú–ê–†–®–†–£–¢–´

| –ì—Ä—É–ø–ø–∞ | Endpoints | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|-----------|--------|-------------|
| **Auth (Public)** | 3 | ‚úÖ | `send-code`, `verify-code`, `refresh` - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |
| **Auth (Protected)** | 1 | ‚úÖ | `logout` - —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ—Ç–∑—ã–≤–∞–µ—Ç refresh —Ç–æ–∫–µ–Ω—ã |
| **Users** | 2 | ‚úÖ | `GET/PUT /me`, `/verify-email-change` - –ø–æ–ª–Ω—ã–π CRUD –ø—Ä–æ—Ñ–∏–ª—è |
| **Organizations** | 4 | ‚úÖ | GET/POST/PUT/DELETE - –ø–æ–ª–Ω—ã–π CRUD + –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ |
| **Documents** | 5 | ‚úÖ | GET/POST/PUT/DELETE + –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ - –ø–æ–ª–Ω—ã–π CRUD |
| **Templates** | 1 | ‚úÖ | GET /templates (–ø—É–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫) |
| **Admin: Access** | 3 | ‚úÖ | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (grant/revoke/history) |
| **Admin: Templates** | 3 | ‚úÖ | CRUD —à–∞–±–ª–æ–Ω–æ–≤ (GET/POST/PUT –ø–æ code) |
| **Admin: Configs** | 2 | ‚úÖ | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ —à–∞–±–ª–æ–Ω–æ–≤ |
| **AI** | 1 | ‚úÖ | `/api/ai/chat` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAI |
| **Files** | 1 | ‚úÖ | `/api/files/parse` - DOCX/PDF/TXT –ø–∞—Ä—Å–∏–Ω–≥ |
| **Export** | 2 | ‚úÖ | `generate-docx`, `generate-pdf` |

**–ò—Ç–æ–≥–æ:** 28 API endpoints (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é)

#### üìä –°–∏–º–º–µ—Ç—Ä–∏—è GET/POST/PUT/DELETE

| –†–µ—Å—É—Ä—Å | GET | POST | PUT | DELETE | –°—Ç–∞—Ç—É—Å |
|--------|-----|------|-----|--------|--------|
| Users | ‚úÖ `/me` | ‚ùå | ‚úÖ `/me` | ‚ùå | ‚ö†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ verify-code |
| Organizations | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Documents | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Templates (Admin) | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

**HTTP Status Codes:**
- ‚úÖ `200 OK` - —É—Å–ø–µ—à–Ω—ã–µ GET/PUT/DELETE
- ‚úÖ `201 Created` - —É—Å–ø–µ—à–Ω—ã–µ POST
- ‚úÖ `400 Bad Request` - –≤–∞–ª–∏–¥–∞—Ü–∏—è Zod
- ‚úÖ `401 Unauthorized` - –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ / –∏—Å—Ç—ë–∫
- ‚úÖ `403 Forbidden` - –Ω–µ—Ç –ø—Ä–∞–≤ / –∏—Å—Ç—ë–∫ –¥–æ—Å—Ç—É–ø
- ‚úÖ `404 Not Found` - —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
- ‚úÖ `409 Conflict` - email –∑–∞–Ω—è—Ç / unique constraint
- ‚úÖ `429 Too Many Requests` - rate limit
- ‚úÖ `500 Internal Server Error` - –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ `503 Service Unavailable` - OpenAI –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

#### üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

| –ê—Å–ø–µ–∫—Ç | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|--------|------------|--------|
| **Try-catch –±–ª–æ–∫–∏** | –í—Å–µ API routes –æ–±—ë—Ä–Ω—É—Ç—ã | ‚úÖ |
| **Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è** | –û—à–∏–±–∫–∏ –ª–æ–≤—è—Ç—Å—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è | ‚úÖ |
| **–ì–ª–æ–±–∞–ª—å–Ω—ã–π handler** | –ù–µ—Ç, –Ω–æ –≤ –∫–∞–∂–¥–æ–º route –µ—Å—Ç—å catch | ‚ö†Ô∏è |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | `console.error()` –¥–ª—è –æ—à–∏–±–æ–∫ | ‚úÖ |
| **Sentry** | –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ `sentry.*.config.ts` | ‚úÖ |
| **Stack trace –∫–ª–∏–µ–Ω—Ç—É** | ‚ùå –ù–µ –æ—Ç–¥–∞—ë—Ç—Å—è, —Ç–æ–ª—å–∫–æ `error.message` | ‚úÖ |
| **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ID** | ‚ùå –ù–µ –æ—Ç–¥–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É | ‚úÖ |

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ error handler middleware. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º route
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: Stack trace –Ω–µ —É—Ç–µ–∫–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –°–æ–∑–¥–∞—Ç—å /lib/api-error-handler.ts
export function handleApiError(error: unknown): NextResponse {
  if (error instanceof z.ZodError) {
    return NextResponse.json({
      error: 'Validation error',
      details: error.issues.map(e => ({
        field: e.path.join('.'),
        message: e.message
      }))
    }, { status: 400 });
  }
  
  console.error('API Error:', error);
  // Sentry.captureException(error);
  
  return NextResponse.json({
    error: 'Internal server error'
  }, { status: 500 });
}
```

#### üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

| Route | –í–∞–ª–∏–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|-------|-----------|--------|
| POST /organizations | `createOrganizationSchema` | ‚úÖ |
| PUT /organizations/:id | `updateOrganizationSchema` | ‚úÖ |
| POST /documents | `createDocumentSchema` | ‚úÖ |
| PUT /documents/:id | `updateDocumentSchema` | ‚úÖ |
| PUT /users/me | `updateUserSchema` | ‚úÖ |
| POST /admin/templates | `createTemplateSchema` | ‚úÖ |
| POST /ai/chat | Manual validation | ‚ö†Ô∏è |
| POST /files/parse | Manual validation | ‚ö†Ô∏è |

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç Zod schemas

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å Zod schemas –¥–ª—è:
- `/api/ai/chat` - –≤–∞–ª–∏–¥–∞—Ü–∏—è `userPrompt`, `templateName`
- `/api/files/parse` - –≤–∞–ª–∏–¥–∞—Ü–∏—è file size/type
- `/api/admin/access/:userId` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç –¥–æ—Å—Ç—É–ø–∞

---

### 4. üß† –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê

| –ú–æ–¥—É–ª—å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|------------|--------|-------------|
| **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Email** | ‚úÖ | 10/10 | 1) –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ 2) –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è 3) JWT 4) Refresh. –ü–æ–ª–Ω—ã–π flow |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏** | ‚úÖ | 9/10 | CRUD –ø—Ä–æ—Ñ–∏–ª—è. –°–º–µ–Ω–∞ email —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π. –ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–∞ |
| **–í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** | ‚úÖ | 10/10 | `accessFrom`-`accessUntil`. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ middleware. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| **Demo –ª–∏–º–∏—Ç—ã** | ‚úÖ | 9/10 | –°—á—ë—Ç—á–∏–∫ `documentsUsed`/`documentsLimit`. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º |
| **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏** | ‚úÖ | 10/10 | CRUD + –≤–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù/–ö–ü–ü/–û–ì–†–ù/—Å—á–µ—Ç–æ–≤. –¢–∏–ø—ã: –Æ–õ/–ò–ü |
| **–î–æ–∫—É–º–µ–Ω—Ç—ã** | ‚úÖ | 9/10 | CRUD + –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ + —à–∞–±–ª–æ–Ω + —Ä–µ–∫–≤–∏–∑–∏—Ç—ã |
| **–®–∞–±–ª–æ–Ω—ã (Admin)** | ‚úÖ | 10/10 | CRUD + enable/disable + —Ç–µ–≥–∏ + –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |
| **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤** | ‚úÖ | 9/10 | JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ |
| **–ò–ò –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞** | ‚úÖ | 9/10 | OpenAI GPT-4 —á–µ—Ä–µ–∑ `/api/ai/chat`. –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |
| **–ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤** | ‚úÖ | 9/10 | DOCX/PDF/TXT/MD. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 15 –ú–ë |
| **–≠–∫—Å–ø–æ—Ä—Ç DOCX** | ‚úÖ | 9/10 | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `docx`. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤/–ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤ |
| **–≠–∫—Å–ø–æ—Ä—Ç PDF** | ‚úÖ | 8/10 | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `pdf-lib`. ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã (Helvetica) |
| **Rate limiting** | ‚úÖ | 10/10 | API: 100 req/min, Auth: 5/min, AI: 10/min. Upstash Redis |
| **Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** | ‚úÖ | 9/10 | Nodemailer + Gmail. –ö–æ–¥—ã –≤—Ö–æ–¥–∞ –∏ —Å–º–µ–Ω—ã email |

#### üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –≤–µ—Ç–≤–µ–π

**–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞** (`POST /api/documents`):
```typescript
// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:
if (user.role !== 'admin') {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  const accessCheck = await checkAccessPeriod(user.id);
  
  if (!accessCheck.hasAccess) {
    // 2. –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ demo –ª–∏–º–∏—Ç–∞
    if (accessCheck.status === 'not_granted') {
      const hasDemoLimit = await checkDemoLimit(user.id);
      if (!hasDemoLimit) {
        return 403; // Demo –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω
      }
    } else {
      return 403; // –î–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ –Ω–∞—á–∞–ª—Å—è
    }
  }
  // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø - –¥–µ–º–æ –ª–∏–º–∏—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
}
```
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –õ–æ–≥–∏–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞–¥ demo –ª–∏–º–∏—Ç–∞–º–∏

**–°–º–µ–Ω–∞ email** (`PUT /api/users/me`):
```typescript
if (validated.email && validated.email.toLowerCase() !== user.email.toLowerCase()) {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç—å email
  const existingUser = await prisma.user.findUnique({ ... });
  if (existingUser && existingUser.id !== userId) {
    throw new Error('Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è');
  }
  
  // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
  const { verification, code, token } = await createEmailVerificationRequest(...);
  await transporter.sendMail({ ... });
  
  // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π (–∫—Ä–æ–º–µ email)
  const updatedUser = await prisma.user.update({ ... });
  
  // 4. –í–æ–∑–≤—Ä–∞—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
  return { ...updatedUser, emailChangePending: true, verificationToken: token };
}
```
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** Email –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

**Refresh —Ç–æ–∫–µ–Ω** (`POST /api/auth/refresh`):
```typescript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –ø–æ–¥–ø–∏—Å–∏
const payload = verifyRefreshToken(refreshTokenValue);
if (!payload) return 401;

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î (revoked, expired)
const refreshTokenRecord = await validateRefreshToken(refreshTokenValue);
if (!refreshTokenRecord) return 401;

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
if (user.email !== payload.email || user.role !== payload.role) {
  await revokeRefreshToken(refreshTokenValue);
  return 401; // –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥
}

// 4. –†–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
await revokeRefreshToken(refreshTokenValue); // –°—Ç–∞—Ä—ã–π
const newRefreshToken = createRefreshToken(...); // –ù–æ–≤—ã–π
await createRefreshTokenRecord(...);
```
‚úÖ **–û—Ç–ª–∏—á–Ω–æ:** –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (JWT + –ë–î). –†–æ—Ç–∞—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### ‚ùå –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ª–æ–≥–∏–∫–∏

**1. –ü—Ä–æ–±–ª–µ–º–∞ —Å `incrementDocumentUsage`:**
```typescript
// –í POST /api/documents/route.ts:
if (user.role !== 'admin') {
  await incrementDocumentUsage(user.id);
}
```
‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –°—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (–Ω–µ –≤ demo —Ä–µ–∂–∏–º–µ)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ demo —Ä–µ–∂–∏–º–µ
if (user.role !== 'admin') {
  const accessCheck = await checkAccessPeriod(user.id);
  if (accessCheck.status === 'not_granted') {
    // –¢–æ–ª—å–∫–æ –¥–ª—è demo –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    await incrementDocumentUsage(user.id);
  }
}
```

**2. –ü—Ä–æ–±–ª–µ–º–∞ —Å PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞):**
```typescript
// –í generate-pdf/route.ts:
const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
```
‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** `Helvetica` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É. –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pdf-lib` —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, DejaVu Sans)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `pdfmake` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã

**3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç—ë–∫—à–∏—Ö LoginToken:**
```typescript
// –í send-code/route.ts –æ—á–∏—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ email
await prisma.loginToken.deleteMany({
  where: {
    email: normalizedEmail,
    used: false,
    expiresAt: { lt: new Date() }
  }
});
```
‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å—Ç—ë–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –ë–î

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –°–æ–∑–¥–∞—Ç—å cron job –∏–ª–∏ API endpoint –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:
// /lib/cleanup.ts
export async function cleanupExpiredTokens() {
  await prisma.loginToken.deleteMany({
    where: { expiresAt: { lt: new Date() } }
  });
  
  await prisma.emailVerification.deleteMany({
    where: { expiresAt: { lt: new Date() } }
  });
  
  await cleanupExpiredRefreshTokens(); // –£–∂–µ –µ—Å—Ç—å
}
```

#### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **Timing Attack Protection** –≤ `/api/auth/send-code`:
   - –ö–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–¥–∞–∂–µ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö email)
   - –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms
   - –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **Rate Limiting** –Ω–∞ —Ç—Ä—ë—Ö —É—Ä–æ–≤–Ω—è—Ö:
   - Global API: 100 req/min per IP (middleware)
   - Auth: 5 req/min per IP
   - AI Chat: 10 req/min per user

3. **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Å—É–±—ä–µ–∫—Ç–∞**:
   ```typescript
   .refine((data) => {
     if (data.subject_type === 'legal_entity') {
       return data.inn.length === 10 && data.kpp && data.ogrn;
     }
     if (data.subject_type === 'sole_proprietor') {
       return data.inn.length === 12 && data.ogrnip;
     }
   })
   ```
   ‚úÖ –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –§–ù–° —Å–æ–±–ª—é–¥–µ–Ω—ã

4. **Access History** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞:
   ```typescript
   await prisma.accessHistory.create({
     data: {
       userId, action, accessFrom, accessUntil,
       comment, updatedBy: adminEmail
     }
   });
   ```
   ‚úÖ –ê—É–¥–∏—Ç trail –¥–ª—è compliance

---

### 5. üßæ –ú–û–î–ï–õ–ò –ò –î–ê–ù–ù–´–ï (Prisma Schema)

| –ú–æ–¥–µ–ª—å | –ü–æ–ª—è | –°–≤—è–∑–∏ | –ò–Ω–¥–µ–∫—Å—ã | –°—Ç–∞—Ç—É—Å |
|--------|------|-------|---------|--------|
| **User** | 23 | 6 | 3 | ‚úÖ |
| **LoginToken** | 7 | 0 | 4 | ‚úÖ |
| **Organization** | 28 | 2 | 4 | ‚úÖ |
| **Document** | 11 | 2 | 3 | ‚úÖ |
| **DemoStatus** | 7 | 1 | 0 | ‚ö†Ô∏è |
| **TemplateConfig** | 4 | 0 | 1 | ‚úÖ |
| **Template** | 10 | 0 | 3 | ‚úÖ |
| **AccessHistory** | 8 | 1 | 2 | ‚úÖ |
| **RefreshToken** | 8 | 1 | 3 | ‚úÖ |
| **EmailVerification** | 8 | 1 | 4 | ‚úÖ |

**–ò—Ç–æ–≥–æ:** 10 –º–æ–¥–µ–ª–µ–π, 41 —Å–≤—è–∑—å (relations), 27 –∏–Ω–¥–µ–∫—Å–æ–≤

#### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:

1. **–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ:**
   ```prisma
   user User @relation(fields: [userId], references: [id], onDelete: Cascade)
   ```
   ‚úÖ –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è—é—Ç—Å—è: organizations, documents, tokens, history

2. **Nullable –ø–æ–ª—è:**
   ```prisma
   organizationId String?
   organization Organization? @relation(...)
   ```
   ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

3. **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö:**
   - ‚úÖ `email`, `inn`, `templateCode` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - ‚úÖ `accessUntil`, `expiresAt` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
   - ‚úÖ `userId` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

4. **JSON –ø–æ–ª—è:**
   ```prisma
   requisites Json? // –ì–∏–±–∫–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
   requisitesConfig Json? // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   ```
   ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

5. **UUID –≤–º–µ—Å—Ç–æ autoincrement:**
   ```prisma
   id String @id @default(uuid())
   ```
   ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ (–Ω–µ—Ç enumeration attack)

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:

**1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ DemoStatus:**
```prisma
model DemoStatus {
  // ...
  @@index([userId]) // ‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢
}
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã `WHERE userId = ...`  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `@@index([userId])`

**2. –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
- `Template` –∏ `templates.ts` (hardcoded —Å–ø–∏—Å–æ–∫)
- –®–∞–±–ª–æ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∏ –≤ –ë–î, –∏ –≤ –∫–æ–¥–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–¥–∞–ª–∏—Ç—å hardcoded `templates.ts`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ë–î
- Seed script –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤

**3. Organization - –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ email:**
```prisma
email String
// ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞, –Ω–æ –ø–æ–∏—Å–∫ –ø–æ email –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç—ã–º
```
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** `@@index([email])`

**4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ constraint –Ω–∞ KPP –¥–ª—è –Æ–õ:**
```prisma
kpp String?
```
Prisma –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç conditional constraints. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ Zod.  
‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å PostgreSQL CHECK constraint —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é

#### üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ nullable –ø–æ–ª–µ–π:

| –ú–æ–¥–µ–ª—å | –ü–æ–ª–µ | Nullable | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ? |
|--------|------|----------|------------|
| User | firstName | ‚úÖ | ‚úÖ –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| User | accessUntil | ‚úÖ | ‚úÖ –ú–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–∞ |
| Organization | kpp | ‚úÖ | ‚ö†Ô∏è –î–ª—è –Æ–õ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Zod) |
| Organization | name_short | ‚úÖ | ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |
| Document | organizationId | ‚úÖ | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ |
| Document | bodyText | ‚úÖ | ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º? –õ–æ–≥–∏—á–Ω–æ –ª–∏? |

**–ü—Ä–æ–±–ª–µ–º–∞:** `Document.bodyText` nullable, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–¥–µ–ª–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ

#### üìä –°–≤—è–∑–∏ (Relations):

**User ‚Üí Organizations (1:N):** ‚úÖ  
**User ‚Üí Documents (1:N):** ‚úÖ  
**User ‚Üí DemoStatus (1:1):** ‚úÖ  
**User ‚Üí AccessHistory (1:N):** ‚úÖ  
**User ‚Üí RefreshTokens (1:N):** ‚úÖ  
**User ‚Üí EmailVerifications (1:N):** ‚úÖ  
**Organization ‚Üí Documents (1:N):** ‚úÖ —Å `onDelete: SetNull` ‚úÖ  

–í—Å–µ —Å–≤—è–∑–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å —É—á—ë—Ç–æ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

#### üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏:

```bash
prisma/migrations/
  ‚ùå 20251028200430_production_init/migration.sql (DELETED)
  ‚ùå migration_lock.toml (DELETED)
```

‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∏–≥—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –∫–æ–¥–æ–º.  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** `bunx prisma migrate dev --name init` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

---

### 6. üß∞ –í–ê–õ–ò–î–ê–¶–ò–ò –ò –û–®–ò–ë–ö–ò

#### üìã Zod Schemas

| Schema | –ü–æ–ª—è | –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|--------|------|------------|-----------|--------|
| `createOrganizationSchema` | 21 | 17 | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | ‚úÖ |
| `updateOrganizationSchema` | 21 | 17 | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | ‚úÖ |
| `createDocumentSchema` | 6 | 4 | –°—Ä–µ–¥–Ω—è—è | ‚úÖ |
| `updateDocumentSchema` | 5 | 3 | –°—Ä–µ–¥–Ω—è—è | ‚úÖ |
| `updateUserSchema` | 5 | 3 | –ù–∏–∑–∫–∞—è | ‚ö†Ô∏è |
| `createTemplateSchema` | 8 | 6 | –°—Ä–µ–¥–Ω—è—è | ‚úÖ |

**–ò—Ç–æ–≥–æ:** 6 –æ—Å–Ω–æ–≤–Ω—ã—Ö schemas —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏

#### ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:

```typescript
// –ò–ù–ù —Å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º–æ–π
inn: z.string()
  .regex(/^\d{10}$|^\d{12}$/)
  .refine((val) => validateINN(cleaned), { message: '...' })

// –ö–ü–ü
kpp: z.string()
  .regex(/^\d{9}$/)
  .refine((val) => !val || validateKPP(val))

// –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ —Å –ë–ò–ö
bank_ks: z.string()
  .regex(/^\d{20}$/)
  .refine((val, ctx) => {
    const bik = ctx.parent.bank_bik;
    return validateBankKSExtended(val, bik);
  })

// –§–ò–û —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
head_fio: z.string()
  .refine((val) => validateFIO(val))

// –¢–µ–ª–µ—Ñ–æ–Ω —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
phone: z.string()
  .refine((val) => !val || validatePhone(val))
```

‚úÖ **–£—Ä–æ–≤–µ–Ω—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏: 10/10** - –£—á—Ç–µ–Ω—ã –≤—Å–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –§–ù–°

#### üõ†Ô∏è –ö–∞—Å—Ç–æ–º–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã (`/lib/utils/validators.ts`):

| –§—É–Ω–∫—Ü–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å |
|---------|----------|--------|
| `validateINN10` | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –ò–ù–ù-10 | ‚úÖ |
| `validateINN12` | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –ò–ù–ù-12 | ‚úÖ |
| `validateOGRN` | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –û–ì–†–ù | ‚úÖ |
| `validateOGRNIP` | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –û–ì–†–ù–ò–ü | ‚úÖ |
| `validateKPP` | –ö–æ–¥ –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ—Ä–≥–∞–Ω–∞ | ‚úÖ |
| `validateBIK` | –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã + —Ä–µ–≥–∏–æ–Ω–∞ | ‚úÖ |
| `validateBankKS` | –ö–æ—Ä—Å—á—ë—Ç —Å –ë–ò–ö (mod 10) | ‚úÖ |
| `validateBankRS` | –†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç —Å –ë–ò–ö | ‚úÖ |
| `validateSNILS` | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –°–ù–ò–õ–° | ‚úÖ |
| `validateFIO` | –ö–∏—Ä–∏–ª–ª–∏—Ü–∞, 3 —Å–ª–æ–≤–∞ | ‚úÖ |
| `validatePhone` | +7XXXXXXXXXX | ‚úÖ |
| `validateEmail` | RFC 5322 + –¥–ª–∏–Ω–∞ | ‚úÖ |
| `validatePassport` | 10 —Ü–∏—Ñ—Ä | ‚úÖ |
| `validateDate` | –î–î.–ú–ú.–ì–ì–ì–ì | ‚úÖ |

**–ò—Ç–æ–≥–æ:** 14 –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤ —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º

‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ:** –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –§–ù–°

#### üìä –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```typescript
export function validateRequisite(
  type: string, 
  value: string, 
  additionalData?: { bik?: string }
): { 
  isValid: boolean; 
  message?: string; 
  normalized?: string; 
}
```

‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 15 —Ç–∏–ø–æ–≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤  
‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ  
‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö  

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

**1. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Zod schema –¥–ª—è:**
- `/api/ai/chat` - `userPrompt`, `templateName`, `conversationHistory`
- `/api/files/parse` - —Ä–∞–∑–º–µ—Ä/—Ç–∏–ø —Ñ–∞–π–ª–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ manual)
- `/api/admin/access/:userId` - –¥–∞—Ç—ã `start_date`, `end_date`

**2. updateUserSchema –Ω–µ–ø–æ–ª–Ω—ã–π:**
```typescript
// –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è phone (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π)
export const updateUserSchema = z.object({
  firstName: z.string().min(1).max(50).optional(),
  lastName: z.string().min(1).max(50).optional(),
  email: z.string().email().optional(),
  position: z.string().max(100).optional().nullable(),
  company: z.string().max(150).optional().nullable(),
  // ‚ö†Ô∏è phone –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
});
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
phone: z.string()
  .refine((val) => !val || validatePhone(val))
  .optional()
  .nullable()
```

#### üéØ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ Zod errors –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º route
- ‚úÖ Prisma errors –ª–æ–≤—è—Ç—Å—è (unique constraint)
- ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ 8+ —Ñ–∞–π–ª–∞—Ö:
if (error instanceof z.ZodError) {
  return NextResponse.json(
    {
      error: 'Validation error',
      details: error.issues.map((e) => ({
        field: e.path.join('.'),
        message: e.message
      }))
    },
    { status: 400 }
  );
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `/lib/api-error-handler.ts` (—Å–º. —Ä–∞–∑–¥–µ–ª 3)

---

### 7. üì§ –í–ù–ï–®–ù–ò–ï –°–ï–†–í–ò–°–´ –ò –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

| –°–µ—Ä–≤–∏—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | –¢–∞–π–º–∞—É—Ç—ã | –°—Ç–∞—Ç—É—Å |
|--------|------------|--------------|------------------|----------|--------|
| **OpenAI** | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | ‚úÖ API key, model, temp | ‚úÖ Try-catch | ‚ùå | ‚ö†Ô∏è |
| **Nodemailer (Gmail)** | –û—Ç–ø—Ä–∞–≤–∫–∞ email –∫–æ–¥–æ–≤ | ‚úÖ EMAIL_USER/PASSWORD | ‚úÖ Try-catch | ‚ùå | ‚ö†Ô∏è |
| **Upstash Redis** | Rate limiting | ‚úÖ URL + token | ‚úÖ Fallback mock | N/A | ‚úÖ |
| **Sentry** | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ | ‚úÖ DSN | ‚úÖ Auto capture | N/A | ‚úÖ |
| **Prisma (Neon)** | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | ‚úÖ DATABASE_URL | ‚úÖ Connection pooling | ‚úÖ 10s | ‚úÖ |
| **pdf-lib** | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF | N/A (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) | ‚úÖ | N/A | ‚ö†Ô∏è |
| **docx** | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DOCX | N/A (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) | ‚úÖ | N/A | ‚úÖ |
| **mammoth** | –ü–∞—Ä—Å–∏–Ω–≥ DOCX | N/A | ‚úÖ | N/A | ‚úÖ |
| **pdf-parse** | –ü–∞—Ä—Å–∏–Ω–≥ PDF | N/A | ‚úÖ | N/A | ‚úÖ |

#### üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:

**1. OpenAI (`/api/ai/chat/route.ts`):**
```typescript
const openai = new OpenAI({ apiKey: apiKey });
const completion = await openai.chat.completions.create({
  model,
  messages,
  max_tokens: maxTokens,
  temperature,
});
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è API key
- Rate limiting (10 req/min per user)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å `try-catch`
- –í–æ–∑–≤—Ä–∞—Ç usage statistics

‚ùå **–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ (–º–æ–∂–µ—Ç –≤–∏—Å–µ—Ç—å –¥–æ–ª–≥–æ)
- –ù–µ—Ç retry –ª–æ–≥–∏–∫–∏
- –ù–µ—Ç fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
const completion = await Promise.race([
  openai.chat.completions.create({ ... }),
  new Promise((_, reject) => 
    setTimeout(() => reject(new Error('Timeout')), 30000)
  )
]);
```

**2. Nodemailer (`/api/auth/send-code/route.ts`):**
```typescript
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: { user: emailUser, pass: emailPassword }
});

await transporter.sendMail({ ... });
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials
- Try-catch –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –í dev mode –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ–¥ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

‚ùå **–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ (–º–æ–∂–µ—Ç –≤–∏—Å–µ—Ç—å)
- –ù–µ—Ç retry
- –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π transporter –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –°–æ–∑–¥–∞—Ç—å singleton transporter –≤ /lib/mailer.ts
let transporter: nodemailer.Transporter | null = null;

export function getMailTransporter() {
  if (!transporter) {
    transporter = nodemailer.createTransport({ ... });
  }
  return transporter;
}
```

**3. Upstash Redis (`/lib/rate-limit.ts`):**
```typescript
const redis = hasUpstash ? new Redis({ ... }) : null;

export async function checkApiRateLimit(identifier: string) {
  if (!apiLimiter) {
    console.warn('[Rate Limit] Upstash –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É');
    return mockLimiter.limit();
  }
  return await apiLimiter.limit(identifier);
}
```

‚úÖ **–û—Ç–ª–∏—á–Ω–æ:**
- Graceful fallback –µ—Å–ª–∏ Redis –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Mock limiter –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- Sliding window –∞–ª–≥–æ—Ä–∏—Ç–º
- –¢—Ä–∏ —Ç–∏–ø–∞ limiters (API, Auth, AI)

‚úÖ **–ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º**

**4. Sentry:**
```typescript
// sentry.*.config.ts
Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
});
```

‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –¥–ª—è client/server/edge
- Auto-instrumentation

‚ö†Ô∏è **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –í –∫–æ–¥–µ –Ω–µ—Ç —è–≤–Ω—ã—Ö `Sentry.captureException()` –≤—ã–∑–æ–≤–æ–≤. Next.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ª—É—á—à–µ.

**5. pdf-lib (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF):**

‚ùå **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –®—Ä–∏—Ñ—Ç Helvetica –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É

```typescript
const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
```

**–°–∏–º–ø—Ç–æ–º:** –†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ "???" –∏–ª–∏ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –í–∞—Ä–∏–∞–Ω—Ç 1: –í—Å—Ç—Ä–æ–∏—Ç—å –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç
import fs from 'fs';
const fontBytes = fs.readFileSync('fonts/DejaVuSans.ttf');
const font = await pdfDoc.embedFont(fontBytes);

// –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pdfmake –≤–º–µ—Å—Ç–æ pdf-lib
import pdfMake from 'pdfmake/build/pdfmake';
import pdfFonts from 'pdfmake/build/vfs_fonts';
pdfMake.vfs = pdfFonts.pdfMake.vfs;
```

#### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π:

| –ê—Å–ø–µ–∫—Ç | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|--------|------------|--------|
| **API keys –≤ env** | ‚úÖ | ‚úÖ |
| **–•–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤** | ‚ùå | ‚úÖ |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤** | –ß–∞—Å—Ç–∏—á–Ω–æ | ‚ö†Ô∏è |
| **–¢–∞–π–º–∞—É—Ç—ã** | ‚ùå | ‚ùå |
| **Retry –ª–æ–≥–∏–∫–∞** | ‚ùå | ‚ùå |
| **Circuit breaker** | ‚ùå | ‚ö†Ô∏è |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤** | ‚úÖ | ‚úÖ |

---

### 8. üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

#### üìä –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:

| –¢–∏–ø —Ç–µ—Å—Ç–æ–≤ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ü–æ–∫—Ä—ã—Ç–∏–µ | –°—Ç–∞—Ç—É—Å |
|------------|------------|----------|--------|
| **Unit tests** | 0 | 0% | ‚ùå |
| **Integration tests** | 10 | ~40% | ‚ö†Ô∏è |
| **E2E tests** | 0 | 0% | ‚ùå |
| **Manual tests** | N/A | N/A | ‚ö†Ô∏è |

#### üîç TestSprite Integration Tests:

```
TC001: send_verification_code_to_email ‚úÖ
TC002: verify_code_and_login_user ‚úÖ
TC003: get_current_user_profile ‚úÖ
TC004: update_user_profile_with_email_change_verification ‚úÖ
TC005: list_user_organizations ‚úÖ
TC006: create_organization_with_valid_requisites ‚úÖ
TC007: get_organization_by_id ‚úÖ
TC008: update_organization_with_validation ‚úÖ
TC009: delete_organization_by_id ‚úÖ
TC010: create_new_document_with_template_support ‚úÖ
```

‚úÖ **–ü–æ–∫—Ä—ã—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã–µ happy paths:**
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (send code, verify)
- User CRUD
- Organizations CRUD
- Documents —Å–æ–∑–¥–∞–Ω–∏–µ

‚ùå **–ù–ï –ø–æ–∫—Ä—ã—Ç—ã:**
- –ê–¥–º–∏–Ω—Å–∫–∏–µ endpoints (`/api/admin/*`)
- AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (`/api/ai/chat`)
- –§–∞–π–ª—ã (`/api/files/parse`)
- Export (PDF/DOCX)
- Templates CRUD
- Refresh token flow
- Access period logic
- Demo limits logic

#### ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

**–ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:**
1. –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–ª–æ—Ö–æ–π –ò–ù–ù, –ö–ü–ü –∏ —Ç.–¥.)
2. –ò—Å—Ç—ë–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã
3. Expired access period
4. Demo limit exceeded
5. 401/403 –æ—à–∏–±–∫–∏
6. Rate limiting
7. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ constraints (duplicate email)
8. –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>15 –ú–ë)
9. Unsupported file types
10. OpenAI timeout/errors

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å 20+ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

#### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:

**1. Unit tests –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤:**
```typescript
// /lib/utils/validators.test.ts
describe('validateINN', () => {
  it('should validate correct INN-10', () => {
    expect(validateINN('7707083893')).toBe(true);
  });
  
  it('should reject invalid INN-10 checksum', () => {
    expect(validateINN('7707083892')).toBe(false);
  });
  
  // ... 50+ cases
});
```

**2. Integration tests –¥–ª—è middleware:**
```typescript
describe('Middleware Auth', () => {
  it('should block /api/documents without token', async () => {
    const response = await fetch('/api/documents');
    expect(response.status).toBe(401);
  });
  
  it('should allow /api/auth/send-code without token', async () => {
    const response = await fetch('/api/auth/send-code', {
      method: 'POST',
      body: JSON.stringify({ email: 'test@test.com' })
    });
    expect(response.status).toBe(200);
  });
});
```

**3. –ú–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:**
```typescript
// –ú–æ–∫–∏ –¥–ª—è:
jest.mock('openai');
jest.mock('nodemailer');
jest.mock('@upstash/redis');
```

---

### 9. ‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

#### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

| –ê—Å–ø–µ–∫—Ç | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –û—Ü–µ–Ω–∫–∞ |
|--------|------------|--------|--------|
| **Database indexes** | 27 –∏–Ω–¥–µ–∫—Å–æ–≤ | ‚úÖ | 9/10 |
| **Connection pooling** | Prisma (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) | ‚úÖ | 10/10 |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (React Query)** | –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ | ‚úÖ | 9/10 |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)** | –ù–µ—Ç (—Ç–æ–ª—å–∫–æ rate limit) | ‚ùå | 5/10 |
| **Lazy loading** | Next.js dynamic imports | ‚úÖ | 9/10 |
| **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** | ‚ùå (–≤—Å–µ –∑–∞–ø–∏—Å–∏) | ‚ùå | 3/10 |
| **N+1 queries** | `include` –≤ Prisma | ‚úÖ | 9/10 |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** | Next.js Image | N/A | N/A |
| **Bundle size** | Treeshaking + minification | ‚úÖ | 9/10 |

**‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

**1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏:**
```typescript
// GET /api/documents - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const documents = await prisma.document.findMany({
  where: { userId: user.id },
  // ‚ùå –ù–µ—Ç take/skip
  orderBy: { createdAt: 'desc' },
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ 1000+ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º –∏ –≤–µ—Ä–Ω—ë—Ç –æ–≥—Ä–æ–º–Ω—ã–π JSON

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
const page = parseInt(request.nextUrl.searchParams.get('page') || '1');
const limit = parseInt(request.nextUrl.searchParams.get('limit') || '20');

const documents = await prisma.document.findMany({
  where: { userId: user.id },
  take: limit,
  skip: (page - 1) * limit,
  orderBy: { createdAt: 'desc' },
});

const total = await prisma.document.count({ where: { userId: user.id } });
```

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ endpoints:**
- `GET /api/documents` ‚ùå
- `GET /api/organizations` ‚ùå
- `GET /api/admin/templates` ‚ùå
- `GET /api/admin/access` ‚úÖ (–µ—Å—Ç—å `take: 20` –≤ history)

**2. –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Ä–æ–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
```typescript
// GET /api/templates - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
// –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 1 —á–∞—Å
const templates = await prisma.template.findMany({
  where: { isEnabled: true },
  orderBy: { createdAt: 'desc' },
});
```

**–†–µ—à–µ–Ω–∏–µ (—Å Upstash Redis):**
```typescript
const cacheKey = 'templates:enabled';
let templates = await redis.get(cacheKey);

if (!templates) {
  templates = await prisma.template.findMany({ ... });
  await redis.set(cacheKey, templates, { ex: 3600 }); // 1 —á–∞—Å
}
```

**3. Text field –≤ select –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:**
```typescript
// GET /api/documents
select: {
  bodyText: true, // ‚ùå –ú–æ–∂–µ—Ç –±—ã—Ç—å 50KB —Ç–µ–∫—Å—Ç–∞
  // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–∫–ª—é—á–∏—Ç—å `bodyText` –∏–∑ —Å–ø–∏—Å–∫–∞, –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ GET/:id

#### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

| –£—è–∑–≤–∏–º–æ—Å—Ç—å | –ó–∞—â–∏—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|------------|--------|--------|
| **SQL Injection** | Prisma (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã) | ‚úÖ |
| **XSS** | React (auto-escaping) | ‚úÖ |
| **CSRF** | SameSite cookies | ‚úÖ |
| **JWT tampering** | Signature verification | ‚úÖ |
| **Password storage** | N/A (passwordless auth) | ‚úÖ |
| **Timing attacks** | 500ms delay, same response | ‚úÖ |
| **Rate limiting** | Upstash Redis | ‚úÖ |
| **HTTPS only** | Secure cookies –Ω–∞ prod | ‚úÖ |
| **Hardcoded secrets** | ‚ùå –ù–µ—Ç | ‚úÖ |
| **Environment validation** | –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT_SECRET | ‚úÖ |
| **Input validation** | Zod (client + server) | ‚úÖ |
| **File upload** | –¢–∏–ø + —Ä–∞–∑–º–µ—Ä (15 –ú–ë) | ‚úÖ |
| **Path traversal** | –ù–µ—Ç file operations —Å user input | ‚úÖ |
| **Denial of Service** | Rate limiting + file size | ‚úÖ |
| **Enumeration attack** | UUID –≤–º–µ—Å—Ç–æ sequential ID | ‚úÖ |
| **Session fixation** | –ù–æ–≤—ã–π JWT –ø—Ä–∏ login | ‚úÖ |
| **Token theft** | HttpOnly cookies | ‚úÖ |
| **Refresh token reuse** | –†–æ—Ç–∞—Ü–∏—è + revocation | ‚úÖ |

**‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 10/10** - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å

#### üîê –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

**1. Content Security Policy:**
```typescript
// next.config.js
const securityHeaders = [
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  }
];
```

**2. Helmet.js –¥–ª—è API:**
```typescript
// middleware.ts
import helmet from 'helmet';

export async function middleware(request: NextRequest) {
  // ... existing middleware
  // –î–æ–±–∞–≤–∏—Ç—å security headers
}
```

**3. –ê—É–¥–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
bun audit
# –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å dependencies
```

**4. Environment variables validation:**
```typescript
// /lib/env-validation.ts
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  JWT_SECRET: z.string().min(32),
  OPENAI_API_KEY: z.string().startsWith('sk-').optional(),
  // ...
});

envSchema.parse(process.env);
```

---

## üìä –§–ò–ù–ê–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ê–£–î–ò–¢–ê

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|----------|--------|-------------|
| **üß© –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—ë–≤ | ‚úÖ | –ß–∏—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Next.js App Router |
| | –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | ‚úÖ | –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç |
| | SOLID –ø—Ä–∏–Ω—Ü–∏–ø—ã | ‚úÖ | 8/10 - SRP/OCP/DIP —Å–æ–±–ª—é–¥–µ–Ω—ã |
| | DRY –ø—Ä–∏–Ω—Ü–∏–ø | ‚ö†Ô∏è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `formatRequisiteLabel` |
| | KISS –ø—Ä–∏–Ω—Ü–∏–ø | ‚úÖ | –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥ |
| **üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | JWT —Ç–æ–∫–µ–Ω—ã | ‚úÖ | Access (15m) + Refresh (7d) |
| | Refresh flow | ‚úÖ | –†–æ—Ç–∞—Ü–∏—è + revocation + –ë–î –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π | ‚úÖ | Middleware + getCurrentUser() |
| | –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ | ‚úÖ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `exp` |
| | –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ | ‚úÖ | Env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–µ—Ç hardcode |
| | Timing attacks | ‚úÖ | 500ms delay + same response |
| | Logout | ‚ö†Ô∏è | –ù–µ –æ—Ç–∑—ã–≤–∞–µ—Ç refresh —Ç–æ–∫–µ–Ω—ã |
| | Session hijacking | ‚úÖ | HttpOnly + Secure + SameSite |
| **üì° API** | REST endpoints | ‚úÖ | 28 endpoints –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |
| | HTTP status codes | ‚úÖ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 200/201/400/401/403/404/429/500 |
| | –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚ö†Ô∏è | –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ handler (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| | –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | ‚ö†Ô∏è | –ù–µ –≤—Å–µ endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç Zod |
| | Rate limiting | ‚úÖ | 3 —É—Ä–æ–≤–Ω—è (API/Auth/AI) |
| | –°–∏–º–º–µ—Ç—Ä–∏—è CRUD | ‚úÖ | Organizations/Documents/Templates –ø–æ–ª–Ω—ã–π CRUD |
| **üß† –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞** | –í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø | ‚úÖ | accessFrom/accessUntil —Å middleware –ø—Ä–æ–≤–µ—Ä–∫–æ–π |
| | Demo –ª–∏–º–∏—Ç—ã | ‚ö†Ô∏è | –°—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –ø–ª–∞—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ |
| | Email verification | ‚úÖ | 6-digit –∫–æ–¥ + token + timing protection |
| | –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ | ‚úÖ | –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –§–ù–° |
| | –î–æ–∫—É–º–µ–Ω—Ç—ã | ‚úÖ | CRUD + —à–∞–±–ª–æ–Ω—ã + —Ä–µ–∫–≤–∏–∑–∏—Ç—ã |
| | AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è | ‚úÖ | OpenAI GPT-4 + –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |
| | –≠–∫—Å–ø–æ—Ä—Ç PDF | ‚ùå | Helvetica –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É |
| | –≠–∫—Å–ø–æ—Ä—Ç DOCX | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| | –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ | ‚úÖ | DOCX/PDF/TXT + 15 –ú–ë –ª–∏–º–∏—Ç |
| **üßæ –ú–æ–¥–µ–ª–∏** | Prisma —Å—Ö–µ–º–∞ | ‚úÖ | 10 –º–æ–¥–µ–ª–µ–π, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ |
| | –ò–Ω–¥–µ–∫—Å—ã | ‚ö†Ô∏è | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç @@index([userId]) –≤ DemoStatus |
| | Nullable –ø–æ–ª—è | ‚ö†Ô∏è | Document.bodyText nullable (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º?) |
| | –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ | ‚úÖ | onDelete: Cascade –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ |
| | –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã | ‚ö†Ô∏è | Template –≤ –ë–î + hardcoded templates.ts |
| | –ú–∏–≥—Ä–∞—Ü–∏–∏ | ‚ùå | –£–¥–∞–ª–µ–Ω—ã, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ |
| **üß∞ –í–∞–ª–∏–¥–∞—Ü–∏—è** | Zod schemas | ‚úÖ | 6 schemas —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏ |
| | –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã | ‚úÖ | –ò–ù–ù/–û–ì–†–ù/–û–ì–†–ù–ò–ü/–°–ù–ò–õ–° - –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å |
| | –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã | ‚úÖ | –ë–ò–ö/–ö–°/–†–° —Å –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º mod 10 |
| | –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω, email | ‚úÖ | –ö–∏—Ä–∏–ª–ª–∏—Ü–∞, —Ñ–æ—Ä–º–∞—Ç +7XXX, RFC 5322 |
| | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | ‚ö†Ô∏è | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ routes |
| **üì§ –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã** | OpenAI | ‚ö†Ô∏è | –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –∏ retry |
| | Nodemailer | ‚ö†Ô∏è | –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞, —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å |
| | Upstash Redis | ‚úÖ | Graceful fallback |
| | Sentry | ‚úÖ | Auto-instrumentation |
| | Prisma/Neon | ‚úÖ | Connection pooling |
| **üß™ –¢–µ—Å—Ç—ã** | Unit tests | ‚ùå | 0 —Ç–µ—Å—Ç–æ–≤ |
| | Integration tests | ‚ö†Ô∏è | 10 TestSprite —Ç–µ—Å—Ç–æ–≤ (40% –ø–æ–∫—Ä—ã—Ç–∏–µ) |
| | –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ | ‚ùå | –ù–µ –ø–æ–∫—Ä—ã—Ç—ã |
| | –ú–æ–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ | ‚ùå | –ù–µ—Ç |
| **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | Database indexes | ‚úÖ | 27 –∏–Ω–¥–µ–∫—Å–æ–≤ |
| | –ü–∞–≥–∏–Ω–∞—Ü–∏—è | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–ø–∏—Å–∫–∞—Ö |
| | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis) | ‚ùå | –¢–æ–ª—å–∫–æ –¥–ª—è rate limit |
| | N+1 queries | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Prisma include |
| | Bundle size | ‚úÖ | Next.js –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
| **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | SQL Injection | ‚úÖ | Prisma –∑–∞—â–∏—â–∞–µ—Ç |
| | XSS | ‚úÖ | React auto-escaping |
| | CSRF | ‚úÖ | SameSite cookies |
| | Rate limiting | ‚úÖ | Upstash Redis |
| | Input validation | ‚úÖ | Zod –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ |
| | File upload | ‚úÖ | –¢–∏–ø + —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| | JWT tampering | ‚úÖ | Signature verification |
| | Hardcoded secrets | ‚úÖ | –ù–µ—Ç |

---

## üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨)

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (P0):

1. **PDF –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É** (Helvetica —à—Ä–∏—Ñ—Ç)
   - **–§–∞–π–ª:** `/api/documents/generate-pdf/route.ts`
   - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DejaVu Sans –∏–ª–∏ pdfmake

2. **–ú–∏–≥—Ä–∞—Ü–∏–∏ Prisma —É–¥–∞–ª–µ–Ω—ã**
   - **–§–∞–π–ª:** `prisma/migrations/`
   - **–†–µ—à–µ–Ω–∏–µ:** `bunx prisma migrate dev --name init`

### ‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (P1):

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏** –≤ —Å–ø–∏—Å–∫–∞—Ö (documents/organizations)
   - **–§–∞–π–ª—ã:** `GET /api/documents`, `GET /api/organizations`
   - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `take/skip` + query params

4. **Logout –Ω–µ –æ—Ç–∑—ã–≤–∞–µ—Ç refresh —Ç–æ–∫–µ–Ω—ã**
   - **–§–∞–π–ª:** `/api/auth/logout/route.ts`
   - **–†–µ—à–µ–Ω–∏–µ:** –í—ã–∑–≤–∞—Ç—å `revokeAllUserRefreshTokens()`

5. **Demo —Å—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–ª–∞—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ**
   - **–§–∞–π–ª:** `POST /api/documents/route.ts`
   - **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å `accessPeriod.status` –ø–µ—Ä–µ–¥ `incrementDocumentUsage()`

6. **–ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è OpenAI –∏ Nodemailer**
   - **–§–∞–π–ª—ã:** `/api/ai/chat`, `/api/auth/send-code`
   - **–†–µ—à–µ–Ω–∏–µ:** `Promise.race()` —Å 30s timeout

### ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (P2):

7. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `formatRequisiteLabel`**
   - **–§–∞–π–ª—ã:** `generate-pdf.ts`, `generate-docx.ts`
   - **–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ `/lib/utils/requisites.ts`

8. **Centralised error handling**
   - **–§–∞–π–ª—ã:** –í—Å–µ API routes
   - **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `/lib/api-error-handler.ts`

9. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ DemoStatus.userId**
   - **–§–∞–π–ª:** `prisma/schema.prisma`
   - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `@@index([userId])`

10. **Nodemailer transporter —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å**
    - **–§–∞–π–ª:** `/api/auth/send-code`, `/api/users/me`
    - **–†–µ—à–µ–Ω–∏–µ:** Singleton –≤ `/lib/mailer.ts`

11. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç Zod schemas –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö API**
    - **–§–∞–π–ª—ã:** `/api/ai/chat`, `/api/files/parse`, `/api/admin/access/:userId`
    - **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å schemas

12. **bodyText –≤ —Å–ø–∏—Å–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**
    - **–§–∞–π–ª:** `GET /api/documents`
    - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ select

### ‚ÑπÔ∏è –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (P3):

13. **–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤**
    - **–§–∞–π–ª:** –ù–µ—Ç cron job
    - **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `/lib/cleanup.ts` + scheduled function

14. **Unit —Ç–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç**
    - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤

15. **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã**
    - **–†–µ—à–µ–Ω–∏–µ:** 20+ integration tests

16. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ Template (–ë–î + –∫–æ–¥)**
    - **–§–∞–π–ª—ã:** `prisma/schema.prisma`, `/lib/data/templates.ts`
    - **–†–µ—à–µ–Ω–∏–µ:** Seed script + —É–¥–∞–ª–∏—Ç—å hardcoded

17. **CSP headers –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç**
    - **–§–∞–π–ª:** `next.config.js`
    - **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å security headers

18. **Environment validation**
    - **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `/lib/env-validation.ts` —Å Zod

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –û–¢–õ–ò–ß–ù–û

1. ‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—ë–≤, –Ω–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. ‚úÖ **JWT flow:** Access + Refresh —Å —Ä–æ—Ç–∞—Ü–∏–µ–π, HttpOnly cookies, –ë–î –ø—Ä–æ–≤–µ—Ä–∫–∞
3. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤:** –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (–ò–ù–ù/–ö–ü–ü/–û–ì–†–ù/—Å—á–µ—Ç–∞)
4. ‚úÖ **–í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø:** –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. ‚úÖ **Rate limiting:** 3 —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã (API/Auth/AI)
6. ‚úÖ **Timing attack protection:** 500ms delay + same response
7. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–µ—Ç SQL injection, XSS, CSRF, hardcoded secrets
8. ‚úÖ **Prisma –º–æ–¥–µ–ª–∏:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–≤—è–∑–∏, –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ, UUID
9. ‚úÖ **Error handling:** Try-catch –≤–µ–∑–¥–µ, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
10. ‚úÖ **OpenAI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** Rate limiting, fallback, clear error messages

---

## üìà –û–¶–ï–ù–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –ö PRODUCTION

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|----------|--------|--------|
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | 95% | ‚úÖ –í—Å–µ —Ñ–∏—á–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | 95% | ‚úÖ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 60% | ‚ö†Ô∏è –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ |
| **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** | 80% | ‚ö†Ô∏è –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | 40% | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ 10 —Ç–µ—Å—Ç–æ–≤ |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | 90% | ‚úÖ –•–æ—Ä–æ—à–∏–π README |
| **Code Quality** | 85% | ‚úÖ TypeScript, Zod, Prisma |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | 80% | ‚úÖ Sentry –Ω–∞—Å—Ç—Ä–æ–µ–Ω |

**–ò–¢–û–ì–û:** 8.5/10

---

## üöÄ ROADMAP –î–û PRODUCTION

### Sprint 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã):
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å PDF –∫–∏—Ä–∏–ª–ª–∏—Ü—É (DejaVu Sans –∏–ª–∏ pdfmake)
- [ ] –°–æ–∑–¥–∞—Ç—å Prisma –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é (documents/organizations)
- [ ] Logout –æ—Ç–∑—ã–≤–∞–µ—Ç refresh —Ç–æ–∫–µ–Ω—ã
- [ ] Demo —Å—á—ë—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è demo –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Sprint 2 (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å):
- [ ] –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è OpenAI (30s)
- [ ] –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è Nodemailer (30s)
- [ ] –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error handler
- [ ] –ò–Ω–¥–µ–∫—Å –Ω–∞ DemoStatus.userId
- [ ] Singleton Nodemailer transporter

### Sprint 3 (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è):
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ (Redis, 1 —á–∞—Å)
- [ ] –£–±—Ä–∞—Ç—å bodyText –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] Cleanup cron job (–∏—Å—Ç—ë–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã)
- [ ] –í—ã–Ω–µ—Å—Ç–∏ formatRequisiteLabel –≤ utils

### Sprint 4 (–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):
- [ ] 20+ unit tests –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤
- [ ] 20+ integration tests (–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
- [ ] –ú–æ–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- [ ] E2E —Ç–µ—Å—Ç—ã (Playwright)

### Sprint 5 (–£–ª—É—á—à–µ–Ω–∏—è):
- [ ] Zod schemas –¥–ª—è –≤—Å–µ—Ö API
- [ ] Environment validation (Zod)
- [ ] CSP headers
- [ ] Seed script –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
- [ ] –£–¥–∞–ª–∏—Ç—å hardcoded templates.ts

---

## üí° –í–´–í–û–î–´

**–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (8.5/10)** —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π.

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. PDF –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä—É—Å—Å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º (Helvetica)
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏)
3. –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (–º–æ–∂–µ—Ç –≤–∏—Å–µ—Ç—å)
4. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (Sprint 1-2) –ø—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ production.**

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ (Next.js 15, TypeScript, Prisma)
- –û—Ç–ª–∏—á–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (JWT, rate limiting, validation)
- –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ (–§–ù–° —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã)
- –ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–ª–≥–∞
- –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

**–î–∞—Ç–∞:** 30 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü–æ–¥–ø–∏—Å—å:** Senior Full-Stack Engineer  
**–í–µ—Ä—Å–∏—è –æ—Ç—á—ë—Ç–∞:** 1.0

