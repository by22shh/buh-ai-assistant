# üîê –ê–£–î–ò–¢ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-29  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** Production  
**–ê—É–¥–∏—Ç–æ—Ä:** Senior Security Engineer

---

## üìä –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ü–†–û–í–ï–†–û–ö

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –†–∏—Å–∫ |
|-----------|----------|--------|-------------------|
| **üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** |
| –ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ | Email-based –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã | ‚úÖ | –ë–µ–∑ –ø–∞—Ä–æ–ª–µ–π, –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Frontend/Backend | JWT –≤ HttpOnly cookies | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |
| –ó–∞—â–∏—Ç–∞ API endpoints | Middleware –Ω–∞ –≤—Å–µ—Ö /api/* | ‚úÖ | –ü—É–±–ª–∏—á–Ω—ã–µ –ø—É—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã |
| –û–±—Ö–æ–¥–Ω—ã–µ –ø—É—Ç–∏ | –û—Ç–∫—Ä—ã—Ç—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã | ‚ö†Ô∏è | `/api/auth/*` –ø—É–±–ª–∏—á–Ω—ã (–Ω–æ—Ä–º–∞–ª—å–Ω–æ) |
| **üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥** |
| –í–∞–ª–∏–¥–∞—Ü–∏—è email | Regex + –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| Rate limit –¥–ª—è –≤—Ö–æ–¥–∞ | 5 –ø–æ–ø—ã—Ç–æ–∫/–º–∏–Ω –Ω–∞ IP | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ Upstash |
| –ó–∞—â–∏—Ç–∞ –æ—Ç timing attacks | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms | ‚úÖ | –ï—Å—Ç—å –≤ send-code |
| –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã | ‚úÖ | –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ email |
| –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | upsertUser | ‚úÖ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ |
| **üîë –¢–æ–∫–µ–Ω—ã –∏ —Å–µ—Å—Å–∏–∏** |
| Access —Ç–æ–∫–µ–Ω | JWT, 15 –º–∏–Ω—É—Ç | ‚úÖ | –ö–æ—Ä–æ—Ç–∫–∏–π TTL |
| Refresh —Ç–æ–∫–µ–Ω | JWT, 7 –¥–Ω–µ–π, –≤ –ë–î | ‚úÖ | –î–æ–ª–≥–∏–π TTL, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î |
| –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ | HttpOnly cookies | ‚úÖ | –ó–∞—â–∏—Ç–∞ –æ—Ç XSS |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ | Auto-refresh –ø—Ä–∏ 401 | ‚úÖ | –í api-client.ts |
| –†–æ—Ç–∞—Ü–∏—è refresh | –í–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | ‚úÖ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞, –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ env |
| –û—Ç–∑—ã–≤ refresh —Ç–æ–∫–µ–Ω–∞ | –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î –ø—Ä–∏ logout | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ middleware | –ù–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ | ‚úÖ | –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| **üë• –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞** |
| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ (env ADMIN_EMAIL) | ‚úÖ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ backend | Middleware + getCurrentUser | ‚úÖ | –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| Admin endpoints | –ü—Ä–æ–≤–µ—Ä–∫–∞ role === 'admin' | ‚úÖ | –í–æ –≤—Å–µ—Ö –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–∞—Ö |
| –í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø | accessFrom/accessUntil | ‚úÖ | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ middleware |
| –î–µ–º–æ-–ª–∏–º–∏—Ç | documentsUsed/Limit | ‚úÖ | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ |
| **‚ùå –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è** |
| HTTP —Å—Ç–∞—Ç—É—Å—ã | 401, 403, 429, 400, 500 | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
| –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ | Stack trace –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è | ‚úÖ | –¢–æ–ª—å–∫–æ –æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ | Zod —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ | ‚úÖ | –î–ª—è —Ñ–æ—Ä–º - –Ω–æ—Ä–º–∞–ª—å–Ω–æ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ 401/403 | –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/login | ‚úÖ | –í api-client.ts |
| **üìã –õ–æ–≥–∏ –∏ –∞—É–¥–∏—Ç** |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤ | –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ | ‚ùå | –ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∞ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ | –ù–µ—Ç | ‚ùå | –¢–æ–ª—å–∫–æ console.error |
| –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è | ‚ùå | –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –ª–æ–≥–∞—Ö | –ù–µ—Ç –ø–∞—Ä–æ–ª–µ–π | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ–¥—ã |
| Sentry –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –ï—Å—Ç—å | ‚úÖ | –ù–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫, –Ω–µ –¥–ª—è security events |
| **üé® UX-–ø–æ–≤–µ–¥–µ–Ω–∏–µ** |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ | ‚úÖ | "–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –∫–æ–¥" |
| –ò—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω | Auto-refresh | ‚úÖ | –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout | –ü—Ä–∏ 401 –ø–æ—Å–ª–µ refresh | ‚úÖ | –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/login |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–µ—Å—Å–∏–∏ | Refresh flow | ‚úÖ | –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ submit | ‚ö†Ô∏è | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç UI (loading state) |
| **üõ°Ô∏è –£—è–∑–≤–∏–º–æ—Å—Ç–∏** |
| XSS | HttpOnly cookies | ‚úÖ | –ó–∞—â–∏—â–µ–Ω–æ |
| CSRF | SameSite strict cookies | ‚ö†Ô∏è | –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ, –Ω–µ—Ç CSRF —Ç–æ–∫–µ–Ω–æ–≤ |
| Session fixation | –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ | ‚úÖ | JWT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ |
| –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ | Refresh rotation –≤–∫–ª—é—á–µ–Ω–∞ | ‚úÖ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º | Zod —Å—Ö–µ–º—ã | ‚úÖ | –ù–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints |
| SQL Injection | Prisma ORM | ‚úÖ | –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã |
| **üîÑ Refresh Flow** |
| –ú–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | POST /api/auth/refresh | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| –û—Ç–∑—ã–≤ –ø—Ä–∏ logout | revokeRefreshToken | ‚úÖ | –†–∞–±–æ—Ç–∞–µ—Ç |
| –û—Ç–∑—ã–≤ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ | –ü—Ä–∏ —Å–º–µ–Ω–µ email | ‚úÖ | revokeAllUserRefreshTokens |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ refresh | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –∏–∑ –ë–î | ‚úÖ | –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ |
| **üìß Email-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** |
| –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ true –ø—Ä–∏ –≤—Ö–æ–¥–µ | ‚ö†Ô∏è | –ù–µ—Ç —è–≤–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ |
| –°–º–µ–Ω–∞ email | –ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π email | ‚úÖ | verify-email-change endpoint |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã | ‚úÖ | –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ |

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚úÖ

**–ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:** Email-based —Å –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º–∏ 6-–∑–Ω–∞—á–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç –ø–∞—Ä–æ–ª–µ–π ‚Üí –Ω–µ—Ç —Ä–∏—Å–∫–∞ —É—Ç–µ—á–∫–∏ —Ö—ç—à–µ–π
- –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Email —É–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–ø–æ–ª—É—á–µ–Ω –∫–æ–¥)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Frontend ‚Üí POST /api/auth/send-code ‚Üí Email —Å –∫–æ–¥–æ–º
         ‚Üí POST /api/auth/verify-code ‚Üí JWT —Ç–æ–∫–µ–Ω—ã –≤ cookies
         ‚Üí –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã ‚Üí Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT
```

**Middleware:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ –≤—Å–µ—Ö `/api/*` –ø—É—Ç—è—Ö
- ‚úÖ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ: `/api/auth/send-code`, `/api/auth/verify-code`, `/api/auth/refresh`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –¥–ª—è `/api/admin/*`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ middleware
- –í—Å–µ API endpoints –∑–∞—â–∏—â–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –†–æ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ middleware –∏ –≤ —Ä–æ—É—Ç–∞—Ö

---

### 2. –¢–æ–∫–µ–Ω—ã –∏ —Å–µ—Å—Å–∏–∏ ‚úÖ

**Access Token:**
- –§–æ—Ä–º–∞—Ç: JWT
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 15 –º–∏–Ω—É—Ç (configurable —á–µ—Ä–µ–∑ `JWT_EXPIRES_IN`)
- –•—Ä–∞–Ω–µ–Ω–∏–µ: HttpOnly cookie `token`
- –ê–ª–≥–æ—Ä–∏—Ç–º: HS256 (—á–µ—Ä–µ–∑ jsonwebtoken)

**Refresh Token:**
- –§–æ—Ä–º–∞—Ç: JWT
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏: 7 –¥–Ω–µ–π
- –•—Ä–∞–Ω–µ–Ω–∏–µ: HttpOnly cookie `refreshToken` + –∑–∞–ø–∏—Å—å –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `RefreshToken`)
- –û—Ç–∑—ã–≤: –§–ª–∞–≥ `revoked` –≤ –ë–î

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å cookies:**
```typescript
{
  httpOnly: true,        // ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
  secure: isProduction,   // ‚úÖ HTTPS —Ç–æ–ª—å–∫–æ –≤ production
  sameSite: 'strict'     // ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF (—á–∞—Å—Ç–∏—á–Ω–æ)
}
```

**Refresh Flow:**
```typescript
1. Access token –∏—Å—Ç–µ–∫ ‚Üí 401
2. api-client.ts –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç /api/auth/refresh
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è refresh token –≤ –ë–î
4. –í—ã–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π access token
5. –†–æ—Ç–∞—Ü–∏—è refresh token (–≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
   - –°—Ç–∞—Ä—ã–π refresh token –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π refresh token
   - –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ ROTATE_REFRESH_TOKENS=false
```

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:**

1. **–ù–µ—Ç —è–≤–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞ access —Ç–æ–∫–µ–Ω–∞**
   - –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ logout (–æ—Ç–∑—ã–≤ refresh —Ç–æ–∫–µ–Ω–∞)
   - Access token –≤–∞–ª–∏–¥–µ–Ω –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL (15 –º–∏–Ω)

**‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- Refresh —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∑—ã–≤–∞
- –ü—Ä–∏ —Å–º–µ–Ω–µ email –≤—Å–µ refresh —Ç–æ–∫–µ–Ω—ã –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏ refresh —Ç–æ–∫–µ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh –ø—Ä–∏ 401 –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

---

### 3. –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ ‚úÖ

**–†–æ–ª–∏:**
- `admin` - –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ email —Å `ADMIN_EMAIL`
- `user` - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π:**

1. **Middleware —É—Ä–æ–≤–µ–Ω—å:**
```typescript
if (ADMIN_PATHS.some(path => pathname.startsWith(path))) {
  if (payload.role !== 'admin') {
    return 403 Forbidden;
  }
}
```

2. **Route —É—Ä–æ–≤–µ–Ω—å:**
```typescript
const user = await getCurrentUser(request);
if (!user) return 401;
if (user.role !== 'admin') return 403;
```

**‚úÖ –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:** Middleware + Route handler

**–í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø:**
- –ü–æ–ª—è `accessFrom` –∏ `accessUntil` –≤ —Ç–∞–±–ª–∏—Ü–µ `User`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ middleware –¥–ª—è —Ä–æ–ª–∏ `user`
- –ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

**–î–µ–º–æ-–ª–∏–º–∏—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `documentsUsed < documentsLimit`
- –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-–ª–∏–º–∏—Ç

**‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –†–æ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –¥–≤—É—Ö —É—Ä–æ–≤–Ω—è—Ö
- –î–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–µ–∑–¥–µ
- –í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ middleware

---

### 4. –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫ ‚úÖ

**XSS (Cross-Site Scripting):**
- ‚úÖ HttpOnly cookies ‚Üí JS –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
- ‚úÖ React —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è (Next.js –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**CSRF (Cross-Site Request Forgery):**
- ‚ö†Ô∏è `SameSite: 'strict'` ‚Üí —á–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞
- ‚ùå –ù–µ—Ç CSRF —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
- ‚ö†Ô∏è –ù–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç cross-origin POST –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

**Timing Attacks:**
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –≤ `/api/auth/send-code`:
```typescript
const baseDelay = 500; // –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
await new Promise(resolve => setTimeout(resolve, baseDelay));
```
- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**User Enumeration:**
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ `/api/auth/send-code`
- ‚úÖ –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ email –≤ —Å–∏—Å—Ç–µ–º–µ
- ‚úÖ –ö–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç

**SQL Injection:**
- ‚úÖ Prisma ORM ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ù–µ—Ç –ø—Ä—è–º–æ–π –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ SQL

**Rate Limiting:**
- ‚úÖ –û–±—â–∏–π API: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω –Ω–∞ IP
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: 5 –ø–æ–ø—ã—Ç–æ–∫/–º–∏–Ω –Ω–∞ IP
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Upstash Redis (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, rate limit –æ—Ç–∫–ª—é—á–µ–Ω)

---

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚úÖ

**HTTP —Å—Ç–∞—Ç—É—Å—ã:**
- ‚úÖ `401 Unauthorized` - –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
- ‚úÖ `403 Forbidden` - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –∏–ª–∏ –∏—Å—Ç–µ–∫ –¥–æ—Å—Ç—É–ø
- ‚úÖ `429 Too Many Requests` - –ø—Ä–µ–≤—ã—à–µ–Ω rate limit
- ‚úÖ `400 Bad Request` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `500 Internal Server Error` - —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ Stack trace –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
- ‚úÖ –û–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–æ—Ä–º (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)

**–ü—Ä–∏–º–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:**
```typescript
return NextResponse.json(
  { error: 'Internal server error' },
  { status: 500 }
);
// ‚ùå –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è: error.stack, error.message (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏)
```

**Frontend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh –ø—Ä–∏ 401
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/login` –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `next` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞

---

### 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç ‚ùå

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**

**–ï—Å—Ç—å:**
- ‚úÖ `console.error` –≤ catch –±–ª–æ–∫–∞—Ö
- ‚úÖ Sentry –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ—à–∏–±–æ–∫
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞ (`AccessHistory` —Ç–∞–±–ª–∏—Ü–∞)

**–ù–µ—Ç:**
- ‚ùå –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è security events:
  - –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
  - –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º endpoints
  - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π
  - –ú–∞—Å—Å–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–≤–æ–∑–º–æ–∂–Ω–∞—è –∞—Ç–∞–∫–∞)
- ‚ùå –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞
- ‚ùå Alerting –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–†–∏—Å–∫–∏:**
- –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è brute-force –∞—Ç–∞–∫
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å patterns –∞—Ç–∞–∫ –ø–æ—Å—Ç—Ñ–∞–∫—Ç—É–º
- –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ–æ–±—ã—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `SecurityLog` –≤ –ë–î:
```prisma
model SecurityLog {
  id          String   @id @default(uuid())
  eventType   String   // "failed_login", "unauthorized_access", "rate_limit_exceeded"
  userId      String?
  ip          String
  userAgent   String?
  details     Json?
  createdAt   DateTime @default(now())
  
  @@index([eventType])
  @@index([ip])
  @@index([createdAt])
}
```

2. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ middleware –∏ auth endpoints
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –≤ Sentry –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

---

### 7. UX –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚úÖ

**–í—Ö–æ–¥:**
- ‚úÖ –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (email ‚Üí –∫–æ–¥)
- ‚úÖ –ü–æ–∫–∞–∑ –∫–æ–¥–∞ –≤ development —Ä–µ–∂–∏–º–µ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ React Query

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–µ–≥–æ —Ç–æ–∫–µ–Ω–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–µ—Å—Å–∏–∏
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–æ–∫
- ‚úÖ Disabled —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–æ–≤

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:**

1. **–ù–µ—Ç —è–≤–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email**
   - –ü–æ–ª–µ `emailVerified` –≤—Å–µ–≥–¥–∞ `true` –ø—Ä–∏ –≤—Ö–æ–¥–µ
   - –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - –†–∏—Å–∫: Email –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–º –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

2. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç UI –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ submit**
   - –ó–∞—â–∏—Ç–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `loading` state
   - –ú–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏, –æ—Ç–∫–ª—é—á–∏–≤ JS

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email (–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ)
2. –î–æ–±–∞–≤–∏—Ç—å server-side –∑–∞—â–∏—Ç—É –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ submit (idempotency keys)

---

### 8. Email-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ‚ö†Ô∏è

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü—Ä–∏ –≤—Ö–æ–¥–µ `emailVerified` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `true`
- –ù–µ—Ç —è–≤–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email

**–°–º–µ–Ω–∞ email:**
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ `/api/users/verify-email-change`
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π email
- ‚úÖ –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–º–µ–Ω–µ –≤—Å–µ refresh —Ç–æ–∫–µ–Ω—ã –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ email —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –†–∏—Å–∫: Email –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–º –∏–ª–∏ –ø–æ–¥–¥–µ–ª—å–Ω—ã–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é email –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ:
1. –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –ø–æ –∫–æ–¥—É, –µ—Å–ª–∏ `emailVerified === false`, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ
2. –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É –¥–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è security events

**–†–∏—Å–∫:** –í—ã—Å–æ–∫–∏–π  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å:
- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
- –ü–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–±–æ—Ä–∞ –∫–æ–¥–æ–≤
- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö security events.

---

### 2. ‚ö†Ô∏è CSRF –∑–∞—â–∏—Ç–∞ –Ω–µ–ø–æ–ª–Ω–∞—è

**–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π  
**–û–ø–∏—Å–∞–Ω–∏–µ:** `SameSite: strict` –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ CSRF –∞—Ç–∞–∫, –Ω–æ –Ω–µ –æ—Ç –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è state-changing –æ–ø–µ—Ä–∞—Ü–∏–π (POST/PUT/DELETE)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å double-submit cookie pattern

---

### 3. ‚ö†Ô∏è Email –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è —è–≤–Ω–æ

**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏ –≤—Ö–æ–¥–µ email –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –≤–≤–µ—Å—Ç–∏ —á—É–∂–æ–π email.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é email –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞.

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

1. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ security events**
   - –¢–∞–±–ª–∏—Ü–∞ `SecurityLog` –≤ –ë–î
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ middleware –∏ auth endpoints
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

2. ~~**–í–∫–ª—é—á–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é refresh —Ç–æ–∫–µ–Ω–æ–≤ –≤ production**~~ ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
   - –†–æ—Ç–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ `ROTATE_REFRESH_TOKENS=false` (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

3. **–£–ª—É—á—à–∏—Ç—å CSRF –∑–∞—â–∏—Ç—É**
   - –î–æ–±–∞–≤–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è state-changing –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π SameSite policy

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

4. **–î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é email**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–∏—Å—å–º–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

5. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É rate limit**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Upstash Redis –≤ production
   - –î–æ–±–∞–≤–∏—Ç—å exponential backoff –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

6. **–î–æ–±–∞–≤–∏—Ç—å server-side –∑–∞—â–∏—Ç—É –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ submit**
   - Idempotency keys –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

7. **–£–ª—É—á—à–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - Dashboard –¥–ª—è security events
   - Alerting –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –≤—Ö–æ–¥–∞–º/–≤—ã—Ö–æ–¥–∞–º

8. **–î–æ–±–∞–≤–∏—Ç—å 2FA (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
   - –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
   - TOTP —á–µ—Ä–µ–∑ Google Authenticator

---

## üìà –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** **8.0/10** ‚¨ÜÔ∏è (–±—ã–ª–æ 7.5/10)

**–†–∞–∑–±–∏–≤–∫–∞:**
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: ‚úÖ 9/10
- –¢–æ–∫–µ–Ω—ã –∏ —Å–µ—Å—Å–∏–∏: ‚úÖ 9/10 ‚¨ÜÔ∏è (–±—ã–ª–æ 8/10 - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è)
- –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞: ‚úÖ 9/10
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫: ‚ö†Ô∏è 7/10 (CSRF —á–∞—Å—Ç–∏—á–Ω–æ)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: ‚úÖ 9/10
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚ùå 3/10
- UX: ‚úÖ 8/10

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (HttpOnly cookies)
- ‚úÖ –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç timing attacks –∏ user enumeration
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è security events
- ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–∞—è CSRF –∑–∞—â–∏—Ç–∞

**–í—ã–≤–æ–¥:** –°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –±–∞–∑–æ–≤—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π –≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

## üìù –ß–ï–ö–õ–ò–°–¢ –î–õ–Ø PRODUCTION

- [x] JWT —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–∂–Ω—ã–π (min 32 —Å–∏–º–≤–æ–ª–∞)
- [x] HttpOnly cookies –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- [x] Secure flag –≤–∫–ª—é—á–µ–Ω –≤ production
- [x] SameSite policy –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [x] Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] Middleware –∑–∞—â–∏—â–∞–µ—Ç –≤—Å–µ API endpoints
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ security events
- [x] –†–æ—Ç–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–æ–≤ –≤–∫–ª—é—á–µ–Ω–∞ (–≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- [ ] CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è state-changing –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω Upstash Redis –¥–ª—è rate limiting
- [ ] Sentry –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è security events

---

**–ê—É–¥–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω:** 2025-01-29  
**–°–ª–µ–¥—É—é—â–∏–π –∞—É–¥–∏—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

