# ✅ Чеклист миграции на Email авторизацию

## Перед началом

- [ ] Есть доступ к Netlify Dashboard
- [ ] Есть доступ к базе данных (Neon Console или DATABASE_URL)
- [ ] Сделан бэкап БД (опционально, но рекомендуется)

---

## Шаг 1: Миграция базы данных (5 минут)

### Выберите один из способов:

**Способ A: Через Neon Console (проще)**

- [ ] Открыть https://console.neon.tech
- [ ] Выбрать проект БД
- [ ] Перейти в SQL Editor
- [ ] Скопировать SQL скрипт из `.same/QUICK_MIGRATION.md`
- [ ] Выполнить (Run)
- [ ] Проверить что команды выполнились без ошибок

**Способ B: Через Prisma CLI**

- [ ] Получить `DATABASE_URL` из Netlify Environment Variables
- [ ] Открыть терминал
- [ ] Выполнить:
  ```bash
  export DATABASE_URL="ваш_url"
  cd buh-ai-assistant
  bunx prisma migrate deploy
  ```
- [ ] Проверить что миграция прошла успешно

---

## Шаг 2: Настройка Email (5 минут)

- [ ] Создать App Password в Gmail: https://myaccount.google.com/apppasswords
  - Выбрать "Mail" → "Other (Custom name)" → "Buh Assistant"
  - Скопировать пароль (16 символов)

- [ ] Добавить в Netlify Environment Variables:
  - `EMAIL_USER=your.email@gmail.com`
  - `EMAIL_PASSWORD=xxxx xxxx xxxx xxxx` (без пробелов!)

- [ ] Сохранить изменения в Netlify

- [ ] Перезапустить деплой (Deploy → Trigger deploy)

---

## Шаг 3: Проверка (3 минуты)

- [ ] Открыть ваш сайт на Netlify
- [ ] Перейти на `/auth/login`
- [ ] Ввести ваш email
- [ ] Проверить почту → должен прийти код
- [ ] Ввести код на сайте
- [ ] Должна произойти авторизация ✅

---

## Шаг 4: Проверка БД

- [ ] Открыть Neon Console → Tables → `User`
- [ ] Проверить что есть колонка `email` ✅
- [ ] Проверить что есть таблица `LoginToken` ✅

---

## Troubleshooting

### Email не приходит
- [ ] Проверить что `EMAIL_USER` и `EMAIL_PASSWORD` правильно настроены
- [ ] Проверить папку Спам
- [ ] Проверить логи Netlify Functions на ошибки
- [ ] Попробовать повторно отправить код

### 500 Internal Server Error
- [ ] Проверить логи в Netlify Functions
- [ ] Убедиться что миграция БД выполнена
- [ ] Проверить что все env переменные настроены
- [ ] Перезапустить деплой

### "Invalid or expired code"
- [ ] Коды действительны 10 минут
- [ ] Попробовать запросить новый код
- [ ] Проверить что таблица `LoginToken` создана в БД

---

## После миграции

- [ ] Удалить старые неиспользуемые коды из БД (опционально):
  ```sql
  DELETE FROM "LoginToken" WHERE "expiresAt" < NOW();
  ```

- [ ] Обновить существующих пользователей с реальными email (если нужно)

- [ ] Протестировать на разных браузерах

---

## ✅ Готово!

Теперь ваше приложение использует Email авторизацию вместо телефонов и мессенджеров!

**Время выполнения:** ~15-20 минут

**Что изменилось:**
- ✅ Авторизация через Email вместо телефона
- ✅ 6-значные коды на почту вместо WhatsApp/Telegram
- ✅ Более простой и безопасный процесс входа
- ✅ Нет зависимости от Auth4App
