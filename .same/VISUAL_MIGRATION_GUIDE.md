# 🎨 Визуальный гайд по миграции БД

Пошаговая инструкция с картинками для миграции через Neon Console.

---

## 📍 Способ 1: Через Neon Console (Рекомендуется)

### Шаг 1: Откройте Neon Console

1. Перейдите на https://console.neon.tech
2. Войдите в аккаунт
3. Вы увидите список ваших проектов

```
┌─────────────────────────────────────────┐
│  Neon Console                           │
├─────────────────────────────────────────┤
│  Your Projects:                         │
│                                         │
│  ● buh-ai-assistant-db                  │
│    PostgreSQL 15                        │
│    Active                               │
│    [Open →]                             │
└─────────────────────────────────────────┘
```

### Шаг 2: Выберите проект БД

Кликните на ваш проект (обычно название содержит "buh" или "assistant")

```
┌─────────────────────────────────────────┐
│  buh-ai-assistant-db                    │
├─────────────────────────────────────────┤
│  Sidebar:                               │
│  ● Home                                 │
│  ● Tables         ← Здесь таблицы       │
│  ● SQL Editor     ← СЮДА!               │
│  ● Branches                             │
│  ● Settings                             │
└─────────────────────────────────────────┘
```

### Шаг 3: Откройте SQL Editor

В левом меню кликните **"SQL Editor"**

```
┌─────────────────────────────────────────┐
│  SQL Editor                             │
├─────────────────────────────────────────┤
│  Run queries against your database      │
│                                         │
│  [New Query]  [History]  [Saved]        │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ -- Enter SQL here              │   │
│  │                                 │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [▶ Run]                                │
└─────────────────────────────────────────┘
```

### Шаг 4: Скопируйте SQL скрипт

Откройте файл `.same/migration.sql` в вашем проекте и **скопируйте весь SQL**

```
┌─────────────────────────────────────────┐
│  VS Code / Same Editor                  │
├─────────────────────────────────────────┤
│  .same/migration.sql                    │
│  ┌─────────────────────────────────┐   │
│  │ BEGIN;                          │   │
│  │                                 │   │
│  │ ALTER TABLE "User"              │   │
│  │ ADD COLUMN IF NOT EXISTS...     │   │
│  │                                 │   │
│  │ ...                             │   │
│  │                                 │   │
│  │ COMMIT;                         │   │
│  └─────────────────────────────────┘   │
│                                         │
│  Ctrl+A → Ctrl+C (копировать всё)      │
└─────────────────────────────────────────┘
```

### Шаг 5: Вставьте в SQL Editor

Вернитесь в Neon Console и вставьте SQL:

```
┌─────────────────────────────────────────┐
│  SQL Editor                             │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ BEGIN;                          │   │
│  │                                 │   │
│  │ ALTER TABLE "User"              │   │
│  │ ADD COLUMN IF NOT EXISTS        │   │
│  │   "email" TEXT;                 │   │
│  │                                 │   │
│  │ ALTER TABLE "User"              │   │
│  │ ADD COLUMN IF NOT EXISTS        │   │
│  │   "emailVerified" BOOLEAN...    │   │
│  │                                 │   │
│  │ ...весь SQL скрипт...           │   │
│  │                                 │   │
│  │ COMMIT;                         │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [▶ Run]  ← НАЖАТЬ СЮДА!                │
└─────────────────────────────────────────┘
```

### Шаг 6: Запустите скрипт

Нажмите большую зеленую кнопку **"Run"** или **Ctrl+Enter**

```
┌─────────────────────────────────────────┐
│  SQL Editor                             │
├─────────────────────────────────────────┤
│  [Running query...]                     │
│                                         │
│  Results:                               │
│  ┌─────────────────────────────────┐   │
│  │ ✅ Query executed successfully  │   │
│  │                                 │   │
│  │ Affected rows: 0                │   │
│  │ Execution time: 127ms           │   │
│  │                                 │   │
│  │ ALTER TABLE                     │   │
│  │ ALTER TABLE                     │   │
│  │ CREATE TABLE                    │   │
│  │ CREATE INDEX                    │   │
│  │ ...                             │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### Шаг 7: Проверьте результат

Перейдите в **Tables** в левом меню:

```
┌─────────────────────────────────────────┐
│  Tables                                 │
├─────────────────────────────────────────┤
│  ● User                                 │
│    - id: uuid                           │
│    - email: text          ← НОВОЕ!      │
│    - emailVerified: bool  ← НОВОЕ!      │
│    - phone: text (nullable)             │
│    - role: text                         │
│    ...                                  │
│                                         │
│  ● LoginToken             ← НОВАЯ!      │
│    - id: uuid                           │
│    - email: text                        │
│    - code: text                         │
│    - token: text                        │
│    ...                                  │
│                                         │
│  ● DemoStatus                           │
│  ● Document                             │
│  ● Organization                         │
└─────────────────────────────────────────┘
```

---

## 📍 Способ 2: Через Prisma CLI (Альтернатива)

### Шаг 1: Получите DATABASE_URL

В Netlify Dashboard:

```
┌─────────────────────────────────────────┐
│  Netlify Dashboard                      │
├─────────────────────────────────────────┤
│  Site settings                          │
│  → Environment variables                │
│                                         │
│  DATABASE_URL                           │
│  postgresql://user:pass@ep-...         │
│  [Copy] ← Скопировать                   │
└─────────────────────────────────────────┘
```

### Шаг 2: Откройте терминал

```bash
# В Same или VS Code откройте терминал
# Ctrl+` или меню View → Terminal
```

### Шаг 3: Установите DATABASE_URL

```bash
export DATABASE_URL="postgresql://user:pass@ep-xxx.aws.neon.tech/neondb?sslmode=require"
```

```
┌─────────────────────────────────────────┐
│  Terminal                               │
├─────────────────────────────────────────┤
│  $ export DATABASE_URL="postgresql://..." │
│  $                                      │
│  $ # URL установлен ✅                 │
└─────────────────────────────────────────┘
```

### Шаг 4: Перейдите в директорию проекта

```bash
cd buh-ai-assistant
```

### Шаг 5: Примените миграции

```bash
bunx prisma migrate deploy
```

```
┌─────────────────────────────────────────┐
│  Terminal                               │
├─────────────────────────────────────────┤
│  $ bunx prisma migrate deploy          │
│                                         │
│  Prisma Migrate                         │
│  Applying migrations:                   │
│  ✅ 20250126_email_auth_migration       │
│                                         │
│  Done in 2.3s                           │
│  $                                      │
└─────────────────────────────────────────┘
```

### Шаг 6: Проверьте (опционально)

```bash
bunx prisma studio
```

Откроется браузер с визуальным редактором БД:

```
┌─────────────────────────────────────────┐
│  Prisma Studio - http://localhost:5555  │
├─────────────────────────────────────────┤
│  Models:                                │
│  ● User                                 │
│  ● LoginToken         ← Должна быть!    │
│  ● DemoStatus                           │
│  ● Document                             │
│  ● Organization                         │
│                                         │
│  Кликните User → проверьте колонки      │
└─────────────────────────────────────────┘
```

---

## ✅ Что делать после миграции?

### 1. Настройте Email

```
┌─────────────────────────────────────────┐
│  Google Account                         │
│  https://myaccount.google.com/          │
│  apppasswords                           │
├─────────────────────────────────────────┤
│  App Passwords                          │
│                                         │
│  Select app: [Mail ▼]                   │
│  Select device: [Other ▼]               │
│    → Buh Assistant                      │
│                                         │
│  [Generate]                             │
│                                         │
│  Your password: xxxx xxxx xxxx xxxx     │
│  [Copy]                                 │
└─────────────────────────────────────────┘
```

### 2. Добавьте в Netlify

```
┌─────────────────────────────────────────┐
│  Netlify - Environment Variables        │
├─────────────────────────────────────────┤
│  Key: EMAIL_USER                        │
│  Value: your.email@gmail.com            │
│  [Add]                                  │
│                                         │
│  Key: EMAIL_PASSWORD                    │
│  Value: xxxxxxxxxxxxxxxx                │
│  [Add]                                  │
│                                         │
│  [Save]                                 │
└─────────────────────────────────────────┘
```

### 3. Перезапустите деплой

```
┌─────────────────────────────────────────┐
│  Netlify - Deploys                      │
├─────────────────────────────────────────┤
│  [Trigger deploy ▼]                     │
│    → Deploy site                        │
│                                         │
│  Building...                            │
│  ██████████ 100%                        │
│                                         │
│  ✅ Published                           │
└─────────────────────────────────────────┘
```

### 4. Тестируйте!

```
┌─────────────────────────────────────────┐
│  Ваш сайт - /auth/login                 │
├─────────────────────────────────────────┤
│  Вход в систему                         │
│                                         │
│  Email адрес:                           │
│  ┌─────────────────────────────────┐   │
│  │ test@example.com                │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [Получить код]                         │
│                                         │
│  ↓ Проверьте почту                      │
│                                         │
│  6-значный код:                         │
│  ┌─────────────────────────────────┐   │
│  │ 123456                          │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [Войти] ✅                             │
└─────────────────────────────────────────┘
```

---

## 🎉 Готово!

Миграция завершена, авторизация работает!

**Время:** 5-10 минут
**Сложность:** Легко ⭐
**Результат:** Email авторизация вместо телефонов ✅

---

## 🆘 Troubleshooting

### ❌ "relation does not exist"

**Проблема:** Миграция не применилась

**Решение:**
1. Проверьте что вы подключены к правильной БД
2. Выполните SQL скрипт заново
3. Проверьте логи на ошибки

### ❌ "column already exists"

**Проблема:** Миграция уже была выполнена

**Решение:** Всё ОК! Ничего делать не нужно ✅

### ❌ "permission denied"

**Проблема:** Нет прав на изменение БД

**Решение:**
1. Используйте owner DATABASE_URL (не read-only)
2. Проверьте права пользователя БД
3. Попробуйте через Neon Console

---

**Есть вопросы?** См. полную документацию в `.same/README.md`
