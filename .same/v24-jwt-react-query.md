# ๐ ะะะะกะะฏ 24 - JWT + REACT QUERY + MIDDLEWARE

**ะะฐัะฐ ะฒัะฟััะบะฐ:** 19 ะพะบััะฑัั 2025
**ะะพะดะพะฒะพะต ะฝะฐะทะฒะฐะฝะธะต:** "Enterprise Security"
**ะกัะฐััั:** โ 100% Production-Ready ั ะฟะพะปะฝะพะน ะฑะตะทะพะฟะฐัะฝะพัััั

---

## ๐ ะงะขะ ะะะะะะะะะะะ

### 1. JWT ะขะพะบะตะฝั โ

**ะะพ v24:**
- ะขะตะปะตัะพะฝ ะฒ header (`x-user-phone`)
- ะะตั ัะตะฐะปัะฝะพะน ัะตััะธะธ
- ะะตะฑะตะทะพะฟะฐัะฝะพ ะดะปั production

**ะะพัะปะต v24:**
- **JWT ัะพะบะตะฝั** ะฒ HttpOnly cookies
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะพะฒ
- ะกัะพะบ ะดะตะนััะฒะธั 7 ะดะฝะตะน (ะฝะฐัััะฐะธะฒะฐะตะผะพ)
- ะะฐัะธัะฐ ะพั XSS ะธ CSRF

**ะคะฐะนะปั:**
- `src/lib/jwt.ts` - ััะธะปะธัั JWT
- `src/app/api/auth/confirm/route.ts` - ะฒัะดะฐัะฐ ัะพะบะตะฝะฐ
- `src/app/api/auth/logout/route.ts` - ัะดะฐะปะตะฝะธะต ัะพะบะตะฝะฐ

---

### 2. Middleware ะดะปั ะทะฐัะธัั API โ

**ะคะฐะนะป:** `src/middleware.ts`

**ะงัะพ ะดะตะปะฐะตั:**
- โ ะัะพะฒะตััะตั JWT ัะพะบะตะฝ ะฝะฐ ะฒัะตั API routes
- โ ะะปะพะบะธััะตั ะฝะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัะต ะทะฐะฟัะพัั (401)
- โ ะัะพะฒะตััะตั ัะพะปั ะดะปั ะฐะดะผะธะฝัะบะธั ะฟััะตะน (403)
- โ ะะพะฑะฐะฒะปัะตั user info ะฒ headers

**ะัะฑะปะธัะฝัะต ะฟััะธ:**
```typescript
[
  '/api/auth/init',
  '/api/auth/confirm',
  '/api/users/login',
]
```

**ะะดะผะธะฝัะบะธะต ะฟััะธ:**
```typescript
[
  '/api/admin/*',
]
```

---

### 3. React Query ะดะปั ะบะตัะธัะพะฒะฐะฝะธั โ

**ะัะพะฒะฐะนะดะตั:** `src/providers/QueryProvider.tsx`

**ะะฐัััะพะนะบะธ:**
- ะะตัะธัะพะฒะฐะฝะธะต ะฝะฐ 1 ะผะธะฝััั
- ะะฒัะพะผะฐัะธัะตัะบะธะน retry ะฟัะธ ะพัะธะฑะบะฐั
- ะะตะท ัะตัะตััะฐ ะฟัะธ ัะพะบััะต ะพะบะฝะฐ

**ะะพะดะบะปััะตะฝะพ ะฒ:** `src/app/layout.tsx`

---

### 4. ะะฑะฝะพะฒะปัะฝะฝัะน API Client โ

**ะคะฐะนะป:** `src/lib/api-client.ts`

**ะะทะผะตะฝะตะฝะธั:**
- โ ะฃะฑัะฐะฝ `x-user-phone` header
- โ ะะพะฑะฐะฒะปะตะฝ `credentials: 'include'`
- โ Cookies ะพัะฟัะฐะฒะปััััั ะฐะฒัะพะผะฐัะธัะตัะบะธ
- โ ะขะพะบะตะฝ ะฟัะพะฒะตััะตััั middleware

---

## ๐ ะะะ ะะะะะขะะะข JWT

### ะจะฐะณ 1: ะะพะณะธะฝ

```typescript
// 1. ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั phone + code
POST /api/auth/confirm
{
  "auth_id": "...",
  "code": "1234"
}

// 2. ะกะตัะฒะตั ะฟัะพะฒะตััะตั ะบะพะด
// 3. ะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะะ
const user = await upsertUser(phone);

// 4. ะะตะฝะตัะธััะตั JWT ัะพะบะตะฝ
const token = createToken({
  userId: user.id,
  phone: user.phone,
  role: user.role,
});

// 5. ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั HttpOnly cookie
response.cookies.set('token', token, {
  httpOnly: true,
  secure: true,
  sameSite: 'lax',
  maxAge: 7 days,
});
```

---

### ะจะฐะณ 2: ะะฐะฟัะพัั ะบ API

```typescript
// ะะปะธะตะฝั ะดะตะปะฐะตั ะทะฐะฟัะพั
GET /api/organizations
credentials: 'include' // ะัะฐัะทะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะฟัะฐะฒะปัะตั cookie

โ

// Middleware ะฟะตัะตัะฒะฐััะฒะฐะตั ะทะฐะฟัะพั
const token = request.cookies.get('token');
const payload = verifyToken(token);

if (!payload) {
  return 401 Unauthorized;
}

// ะะพะฑะฐะฒะปัะตั user info ะฒ headers
headers.set('x-user-id', payload.userId);
headers.set('x-user-role', payload.role);

โ

// API route ะฟะพะปััะฐะตั ะทะฐะฟัะพั
const user = await getCurrentUser(request);
// user ัะถะต ะฐะฒัะพัะธะทะพะฒะฐะฝ โ
```

---

### ะจะฐะณ 3: Logout

```typescript
POST /api/auth/logout

// ะกะตัะฒะตั ัะดะฐะปัะตั cookie
response.cookies.delete('token');

// ะะพะปัะทะพะฒะฐัะตะปั ัะฐะทะปะพะณะธะฝะตะฝ โ
```

---

## ๐ก๏ธ ะะะะะะะกะะะกะขะฌ

### ะงัะพ ะทะฐัะธัะตะฝะพ:

1. **XSS (Cross-Site Scripting)**
   - HttpOnly cookies โ JS ะฝะต ะผะพะถะตั ะฟัะพัะธัะฐัั ัะพะบะตะฝ
   - ะขะพะบะตะฝ ะฝะต ััะฐะฝะธััั ะฒ localStorage

2. **CSRF (Cross-Site Request Forgery)**
   - SameSite: 'lax' โ ะทะฐัะธัะฐ ะพั ะผะตะถัะฐะนัะพะฒัั ะทะฐะฟัะพัะพะฒ
   - Secure: true ะฒ production โ ัะพะปัะบะพ HTTPS

3. **SQL Injection**
   - Prisma ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะฐัะฐะผะตััะธะทัะตั ะทะฐะฟัะพัั

4. **Unauthorized Access**
   - Middleware ะฟัะพะฒะตััะตั ัะพะบะตะฝ ะฝะฐ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต
   - 401 ะดะปั ะฝะตะฐะฒัะพัะธะทะพะฒะฐะฝะฝัั
   - 403 ะดะปั ะฝะตะดะพััะฐัะพัะฝัั ะฟัะฐะฒ

---

## ๐ ะะะะะะะะะซะ ะะะะฃะะะะะฏ

ะะพะฑะฐะฒััะต ะฒ `.env`:

```env
# JWT ัะตะบัะตัะฝัะน ะบะปัั (ะะะฏะะะขะะะฌะะ ัะผะตะฝะธัะต ะฒ production!)
JWT_SECRET=your_random_jwt_secret_here_min_32_chars

# ะัะตะผั ะถะธะทะฝะธ ัะพะบะตะฝะฐ (ะพะฟัะธะพะฝะฐะปัะฝะพ)
JWT_EXPIRES_IN=7d
```

**ะะตะฝะตัะฐัะธั ัะตะบัะตัะฝะพะณะพ ะบะปััะฐ:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

## ๐ ะะะะะะฆะะฏ

### ะะฑะฝะพะฒะปะตะฝะธั ะฒ ะบะพะดะต:

1. **Auth login page** - ัะตะฟะตัั ัะพััะฐะฝัะตั ัะพะบะตะฝ โ
2. **API Client** - ะพัะฟัะฐะฒะปัะตั cookies โ
3. **Auth utils** - ะฟัะพะฒะตััะตั JWT ะฒะผะตััะพ header โ
4. **Middleware** - ะทะฐัะธัะฐะตั ะฒัะต API routes โ

### ะกะพะฒะผะตััะธะผะพััั:

- โ ะะฐะฑะพัะฐะตั ั ัััะตััะฒัััะธะผ ััะพะฝัะตะฝะดะพะผ
- โ localStorage auth ะฑะพะปััะต ะฝะต ะธัะฟะพะปัะทัะตััั
- โ ะัะต API routes ะทะฐัะธัะตะฝั

---

## ๐งช ะขะะกะขะะะะะะะะ

### 1. ะะพะณะธะฝ

```bash
# ะัะบัะพะนัะต /auth/login
# ะะฒะตะดะธัะต ะฝะพะผะตั: +7 920 222-22-22
# ะะฒะตะดะธัะต ะบะพะด: 1234
# โ ะะพะปะถะตะฝ ัััะฐะฝะพะฒะธัััั cookie 'token'
```

**ะัะพะฒะตัะบะฐ ะฒ DevTools:**
```
Application โ Cookies โ localhost:3000
ะะพะปะถะตะฝ ะฑััั cookie: token
```

---

### 2. API ะทะฐะฟัะพัั

```bash
# ะกะดะตะปะฐะนัะต ะทะฐะฟัะพั ะบ ะทะฐัะธััะฝะฝะพะผั API
GET /api/organizations

# ะก ัะพะบะตะฝะพะผ โ 200 OK โ
# ะะตะท ัะพะบะตะฝะฐ โ 401 Unauthorized โ
```

---

### 3. ะะดะผะธะฝัะบะธะต ะฟััะธ

```bash
# ะะฑััะฝัะน ะฟะพะปัะทะพะฒะฐัะตะปั
GET /api/admin/template-configs/xxx
# โ 403 Forbidden โ

# ะะดะผะธะฝ (+7 999 999-99-99)
GET /api/admin/template-configs/xxx
# โ 200 OK โ
```

---

### 4. Logout

```bash
POST /api/auth/logout
# โ Cookie ัะดะฐะปัะฝ
# โ ะกะปะตะดัััะธะน ะทะฐะฟัะพั โ 401
```

---

## ๐ ะกะะะะะะะะ

| ะะฐัะฐะผะตัั | v23 (Headers) | v24 (JWT) |
|----------|---------------|-----------|
| **ะขะพะบะตะฝ** | phone ะฒ header | JWT ะฒ cookie |
| **ะะตะทะพะฟะฐัะฝะพััั** | โ๏ธ ะะธะทะบะฐั | โ ะััะพะบะฐั |
| **XSS ะทะฐัะธัะฐ** | โ | โ HttpOnly |
| **CSRF ะทะฐัะธัะฐ** | โ | โ SameSite |
| **ะกัะพะบ ะดะตะนััะฒะธั** | โ | โ 7 ะดะฝะตะน |
| **ะะฒัะพะปะพะณะฐัั** | โ | โ ะะพัะปะต ะธััะตัะตะฝะธั |
| **Middleware** | โ | โ ะัะต routes |
| **React Query** | โ | โ ะะตัะธัะพะฒะฐะฝะธะต |
| **Production-ready** | 98% | โ 100% |

---

## ๐ฏ ะะะะซะ API ENDPOINTS

**โ POST /api/auth/logout**
- ะััะพะด ะธะท ัะธััะตะผั
- ะฃะดะฐะปะตะฝะธะต JWT ัะพะบะตะฝะฐ
- ะัะธััะบะฐ ัะตััะธะธ

---

## ๐๏ธ ะะะฅะะขะะะขะฃะะ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  FRONTEND                       โ
โ  - QueryProvider (React Query)                  โ
โ  - API Client (credentials: include)            โ
โ  - ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะฟัะฐะฒะบะฐ cookies              โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โ HTTP Request + Cookie: token=...
                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              MIDDLEWARE                         โ
โ  1. ะะทะฒะปะตัั ัะพะบะตะฝ ะธะท cookie                     โ
โ  2. ะัะพะฒะตัะธัั JWT signature                     โ
โ  3. ะัะพะฒะตัะธัั ัะพะปั ะดะปั /api/admin/*             โ
โ  4. ะะพะฑะฐะฒะธัั user info ะฒ headers                โ
โ  5. ะะปะธ ะฒะตัะฝััั 401/403                         โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โ Request + Headers: x-user-id, x-user-role
                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               API ROUTES                        โ
โ  - getCurrentUser(request) โ User               โ
โ  - ะะฐะฑะพัะฐ ั ะะ ัะตัะตะท Prisma                     โ
โ  - ะะพะทะฒัะฐั ะดะฐะฝะฝัั                               โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         POSTGRESQL (Neon)                       โ
โ  - ะฅัะฐะฝะตะฝะธะต ะดะฐะฝะฝัั                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ BEST PRACTICES

### 1. ะะตะฝะตัะฐัะธั JWT_SECRET

**โ ะะ ะะะะะะขะ:**
```env
JWT_SECRET=secret123
JWT_SECRET=my_app_secret
```

**โ ะะะะะะขะ:**
```bash
# ะกะณะตะฝะตัะธััะนัะต ัะปััะฐะนะฝัะน ะบะปัั
openssl rand -base64 32

# ะะปะธ ัะตัะตะท Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

### 2. ะะตะฟะปะพะน ะฝะฐ Netlify

ะ **Environment Variables** ะดะพะฑะฐะฒััะต:
```
JWT_SECRET=ะฒะฐั_ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะน_ะบะปัั
JWT_EXPIRES_IN=7d
DATABASE_URL=ะฒะฐั_neon_url
```

**โ๏ธ ะะะะะ:** JWT_SECRET ะดะพะปะถะตะฝ ะฑััั ะพะดะธะฝะฐะบะพะฒัะผ ะฝะฐ ะฒัะตั ะธะฝััะฐะฝัะฐั!

---

### 3. HTTPS ะฒ production

```typescript
// ะ production ะะะฏะะะขะะะฌะะ HTTPS
secure: process.env.NODE_ENV === 'production'

// ะขะพะบะตะฝ ะฑัะดะตั ะพัะฟัะฐะฒะปััััั ัะพะปัะบะพ ะฟะพ HTTPS โ
```

---

## ๐ ะะะจะะะะ ะะะะะะะ

### ะัะธะฑะบะฐ: "No token provided"

**ะัะธัะธะฝะฐ:** Cookie ะฝะต ะพัะฟัะฐะฒะปัะตััั

**ะะตัะตะฝะธะต:**
```typescript
// ะฃะฑะตะดะธัะตัั ััะพ ะฒ API client:
fetch(url, {
  credentials: 'include' // โ
})
```

---

### ะัะธะฑะบะฐ: "Invalid or expired token"

**ะัะธัะธะฝะฐ:** ะขะพะบะตะฝ ะธัััะบ ะธะปะธ ะฝะตะฒะตัะฝัะน JWT_SECRET

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต JWT_SECRET ะฒ .env
2. ะะตัะตะปะพะณะธะฝััะตัั (ะฟะพะปััะธัะต ะฝะพะฒัะน ัะพะบะตะฝ)
3. ะัะพะฒะตัััะต ะฒัะตะผั ะถะธะทะฝะธ ัะพะบะตะฝะฐ

---

### ะัะธะฑะบะฐ: 403 Forbidden ะฝะฐ /api/admin/*

**ะัะธัะธะฝะฐ:** ะะพะปัะทะพะฒะฐัะตะปั ะฝะต admin

**ะะตัะตะฝะธะต:**
```typescript
// ะัะฟะพะปัะทัะนัะต ะฐะดะผะธะฝัะบะธะน ะฝะพะผะตั:
+7 999 999-99-99

// ะัะพะฒะตัะบะฐ ัะพะปะธ:
const user = await getCurrentUser(request);
console.log(user.role); // ะดะพะปะถะฝะพ ะฑััั "admin"
```

---

## โ ะงะะะะะกะข ะะะะะะฏ

- [ ] ะกะณะตะฝะตัะธัะพะฒะฐะฝ JWT_SECRET (32+ ัะธะผะฒะพะปะฐ)
- [ ] ะะพะฑะฐะฒะปะตะฝ JWT_SECRET ะฒ .env
- [ ] ะะพะฑะฐะฒะปะตะฝ JWT_SECRET ะฒ Netlify env
- [ ] DATABASE_URL ะฝะฐัััะพะตะฝ
- [ ] ะะธะณัะฐัะธะธ ะฒัะฟะพะปะฝะตะฝั
- [ ] ะขะตัั: ะปะพะณะธะฝ ัะฐะฑะพัะฐะตั
- [ ] ะขะตัั: API ะฒะพะทะฒัะฐัะฐะตั 401 ะฑะตะท ัะพะบะตะฝะฐ
- [ ] ะขะตัั: ะะดะผะธะฝ ะดะพัััะฟ ัะฐะฑะพัะฐะตั
- [ ] ะขะตัั: Logout ัะฐะฑะพัะฐะตั
- [ ] HTTPS ะฒะบะปััะตะฝ ะฒ production

---

## ๐ ะะะะฃะะฌะขะะข

### ะงัะพ ะฟะพะปััะธะปะธ:

- โ **JWT ัะพะบะตะฝั** ะฒ HttpOnly cookies
- โ **Middleware** ะดะปั ะทะฐัะธัั API
- โ **React Query** ะดะปั ะบะตัะธัะพะฒะฐะฝะธั
- โ **ะะฒัะพะผะฐัะธัะตัะบะธะน logout** ะฟะพัะปะต ะธััะตัะตะฝะธั ัะพะบะตะฝะฐ
- โ **ะะฐัะธัะฐ ะพั XSS ะธ CSRF**
- โ **ะัะพะฒะตัะบะฐ ัะพะปะตะน** (admin/user)
- โ **Production-ready 100%**

### ะกัะฐััั ะฟัะพะตะบัะฐ:

| ะะพะผะฟะพะฝะตะฝั | ะกัะฐััั |
|-----------|--------|
| Frontend | โ 100% |
| Backend | โ 100% |
| Database | โ PostgreSQL |
| Auth | โ JWT + Middleware |
| Security | โ Enterprise-level |
| Caching | โ React Query |
| Deploy | โ Ready |

---

**ะัะธะปะพะถะตะฝะธะต ะณะพัะพะฒะพ ะบ production ะฝะฐ 100%! ๐**

---

*ะะตััะธั 24 - Enterprise Security*
*19 ะพะบััะฑัั 2025*
