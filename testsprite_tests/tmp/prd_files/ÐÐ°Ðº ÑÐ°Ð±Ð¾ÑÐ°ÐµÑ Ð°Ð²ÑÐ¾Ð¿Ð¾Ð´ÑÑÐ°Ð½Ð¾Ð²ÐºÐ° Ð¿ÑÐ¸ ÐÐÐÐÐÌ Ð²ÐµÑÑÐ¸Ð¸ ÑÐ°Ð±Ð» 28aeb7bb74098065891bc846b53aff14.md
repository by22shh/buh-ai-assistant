# Как работает автоподстановка при НОВОЙ версии шаблона:

## Связанные страницы

- [Реквизиты шаблона (Admin)](%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%A0%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D1%8B%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%C2%BB%20(Admin)%2028aeb7bb740980259c6bc2f927c441ac.md) — список полей хранится на уровне версии.
- [Заполнение реквизитов (User)](../%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%20%D1%81%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D0%BC%D0%B8%20(User)%20290eb7bb7409804da0aed86f3433deb2/%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%97%D0%B0%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%80%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D0%BE%D0%B2%C2%BB%20(User)%2028feb7bb7409809eac65ca6a6512831e.md) — когда и как подставляются значения из организации.
- [Редактирование шаблона (Admin)](%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%A0%D0%B5%D0%B4%D0%B0%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%C2%BB%20(Admin)%2028aeb7bb740980899c14e7304dd6f285.md) — публикация новой версии docx и её влияние.

## Что привязывается к версии

- У каждой опубликованной версии шаблона есть **список system_name полей реквизитов** (чек-боксы, что админ отметил на странице «Реквизиты шаблона»).
- Этот список хранится **внутри версии** (`templateCode + version`). Старые версии — со своим списком; новые — со своим.

## Когда происходит автоподстановка

- **Только в момент создания документа** по шаблону (конкретной опубликованной версии).
- Пользователь выбирает **организацию** → система пробегает по списку реквизитов этой версии и **подтягивает все доступные значения** из карточки организации.
- Если у организации поле пустое — в форме остаётся пусто, пользователь вводит вручную.

## Что меняется при публикации новой версии

- После публикации **новые документы** создаются **строго по новой версии**:
    - Поля, которые **сохранились** между версиями (одинаковые `system_name`), заполнятся из организации как раньше.
    - Поля, которые **добавили** в новой версии, тоже автоподтянутся (если в организации есть значение).
    - Поля, которые **убрали** в новой версии, просто **не будут присутствовать** в форме.
- **Ранее созданные документы** (и черновики) **не трогаем**: они привязаны к своей старой версии, их автозаполнение уже произошло при создании.

## Если пользователь сменил организацию на форме

- При смене организации **в текущем (ещё не созданном/не сохранённом) документе** автоподстановка выполняется **ещё раз для всех полей версии**.
- Значения, которые пользователь уже вручную правил, можно:
    - либо перезаписывать (простое правило),
    - либо спрашивать подтверждение.
        
        В вашем упрощённом варианте — **перезаписываем** (меньше логики).
        

## Важные инварианты

- **Никаких ручных маппингов**: автоподстановка работает по **совпадению `system_name`** между версией шаблона и объектом организации (истина — JSON-schema полей реквизитов).
- **system_name неизменяем**: если нужно переименовать поле — это новое поле. Старое при желании исключают из новой версии.
- **Нет фоновых обновлений**: изменение реквизитов организации **не** меняет уже созданные документы. Автоподстановка — это одноразовый шаг при создании.

## Псевдо-алгоритм

```
input: templateVersion.requisites[] (array of system_name), organization{}, form{}
for each field in templateVersion.requisites:
    if organization[field] is not empty:
        form[field] = normalize(organization[field])
    else:
        form[field] = ""
// далее пользователь может редактировать form[field] вручную

```

Этого достаточно:

— админ публикует новую версию (со своим списком полей) → все новые документы берут **только** её список и **автоматически** подтягивают всё возможное из выбранной организации.