# Страница «Тело документа — чат» (User)

**Назначение:** получить текст **тела документа** через диалог в формате ChatGPT.

**Жёсткое правило:** реквизиты **никогда** не отправляются в ИИ. При обнаружении в тексте или файле — **отклонить** ввод/загрузку и показать ошибку.

## Связанные страницы

- [Заполнение реквизитов](%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%97%D0%B0%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%80%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D0%BE%D0%B2%C2%BB%20(User)%2028feb7bb7409809eac65ca6a6512831e.md) — «Далее» ведёт к форме реквизитов.
- [Мой архив документов](%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%9C%D0%BE%D0%B9%20%D0%B0%D1%80%D1%85%D0%B8%D0%B2%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2%C2%BB%20(User)%2028feb7bb740980a58c4ac31e22acfd43.md) — сохранённые результаты чат-сборки.
- [Страница с шаблонами](../%D0%9A%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2%20(Admin)%20290eb7bb740980fbb1f9e84a8df0ee21/%D0%9A%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2%20%E2%80%94%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%20(Admin)%2028aeb7bb740980fcac13d4842d08e63d.md) — точка входа при hasBodyChat=true.
- [Модуль проверки (JS)](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8%20(%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D1%8B%D0%B9%20%D0%BA%D0%BE%D0%B4,%20JS)%20requisitesGuard%20%2028feb7bb7409805ab92ddac72668c178.md)— готовый модуль проверок для валидаций

---

## Вход и маршрут

- Вход из каталога шаблонов, **если** у шаблона `hasBodyChat = Да`.
- Маршрут: `/doc/:docId/body`.

---

## Роли и доступ

- Доступен **пользователю** (владельцу документа).

---

## Макет (desktop)

- Заголовок: **Тело документа — чат**
- Подзаголовок: `<Название шаблона> · <Версия>`
- Инфо-баннер (над лентой):
    
    > Реквизиты организации не отправляются в ИИ. Обрабатываем только текст тела.
    > 
- Лента чата:
    - Сообщения **пользователя** — справа, **единым блоком** (как в ChatGPT).
    - Сообщения **ИИ** — слева, **единым блоком**.
- Нижняя панель:
    - Многострочное поле ввода
    - Кнопка **Прикрепить файл** (`.docx`, `.pdf`, `.txt`, `.md`)
    - Кнопка **Отправить**
- Основная CTA (правый нижний угол): **Перейти к реквизитам** — активна, когда получен валидный ответ ИИ (**заполнен `bodyText`**). Черновиков **нет**.

---

## Поведение

### 1) Отправка текста

- Перед вызовом ИИ:
    - `const res = checkNoRequisites(inputText);`
    - Если `res.ok === false` → **отклонить** отправку, показать `res.message`, **ничего** в ИИ не отправлять.
    - Если `res.ok === true` → отправить в ИИ; ответ отобразить слева **одним сообщением**.

### 2) Загрузка файла

- После выбора файла:
    - Преобразовать содержимое в текст (парсером `.docx/.pdf` по месту).
    - `const res = checkNoRequisites(fileText);`
    - Если `res.ok === false` → **отклонить** файл, показать `res.message`.
    - Если `res.ok === true` → использовать текст как вход в ИИ; ответ отобразить слева **одним сообщением**.

### 3) Переход к реквизитам

- Становится доступным **после первого валидного ответа ИИ**.
- По нажатию — сохранить:
    - `templateCode`, `templateVersion`
    - `bodyText` (последний валидный ответ ИИ, подтверждённый пользователем)
- Редирект: `/doc/:docId/requisites`.

---

## Валидация «нет реквизитов»

- Единая точка истины — модуль `requisitesGuard.js`.
- Использовать только вызов `checkNoRequisites(text, { ctxWindow?: number })`.
- **Политика:** никаких автозамен/очисток — **только отказ** при срабатывании.

**Контракт функции (из модуля):**

```tsx
type RequisitesReason =
  | "inn" | "kpp" | "ogrn" | "ogrnip"
  | "bik_ctx" | "account_ctx"
  | "email" | "phone"
  | "fio_labeled" | "address_labeled";

type RequisitesCheckResult = {
  ok: boolean;               // true → можно отправлять в ИИ
  reason?: RequisitesReason; // причина первого срабатывания
  message?: string;          // Готовый текст ошибки
  index?: number;            // Позиция первого совпадения
};

```

**Единый текст ошибки (должен совпадать с модулем):**

`"В тексте обнаружены реквизиты (ИНН/КПП/ОГРН/счёт/БИК/e-mail/телефон/ФИО/адрес). Удалите их и попробуйте снова."`

> На UI показываем ровно res.message из функции, без переиначивания. При желании можно логировать res.reason/res.index.
> 

---

## Сигналы доступности

- **Отправить** — активна, если поле ввода непустое.
- **Прикрепить файл** — всегда активна.
- **Перейти к реквизитам** — активна, если `bodyText` заполнен (получен валидный ответ ИИ).

---

## Критерии приёмки (QA)

1. Сообщения пользователя — справа, ИИ — слева; **единые блоки** (как ChatGPT).
2. При срабатывании `checkNoRequisites()` для текста/файла — показывается **точно** `res.message`, запрос в ИИ **не выполняется**.
3. Кнопка **Перейти к реквизитам** активируется **только** после валидного ответа ИИ (есть `bodyText`).
4. При переходе — сохраняются `templateCode`, `templateVersion`, `bodyText`, затем редирект на `/doc/:docId/requisites`.
5. Черновиков/автосохранений **нет**.