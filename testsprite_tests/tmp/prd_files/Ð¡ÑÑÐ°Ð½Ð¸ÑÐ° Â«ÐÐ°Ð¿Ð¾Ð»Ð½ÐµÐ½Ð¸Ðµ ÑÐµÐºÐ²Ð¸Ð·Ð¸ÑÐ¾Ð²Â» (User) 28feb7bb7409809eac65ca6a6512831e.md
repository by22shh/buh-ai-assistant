# Страница «Заполнение реквизитов» (User)

**Коротко:** пользователь (опционально) выбирает организацию, автоподтягивает реквизиты один раз, правит при необходимости и собирает документ.

**Формула:** **Шаблон + (опционально) Тело + Реквизиты ⇒ Готовый документ (DOCX/PDF)**.

ИИ на этой странице **не используется**.

---

## Связанные страницы

- [Реквизиты шаблона (Admin)](../%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%D0%BC%D0%B8(Admin)%20290eb7bb740980f4b9cbddad53d459a6/%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%A0%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D1%8B%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%C2%BB%20(Admin)%2028aeb7bb740980259c6bc2f927c441ac.md) — состав полей формы.
- [Как работает автоподстановка…](../%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%D0%BC%D0%B8(Admin)%20290eb7bb740980f4b9cbddad53d459a6/%D0%9A%D0%B0%D0%BA%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82%20%D0%B0%D0%B2%D1%82%D0%BE%D0%BF%D0%BE%D0%B4%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BF%D1%80%D0%B8%20%D0%9D%D0%9E%D0%92%D0%9E%D0%99%20%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8%20%D1%88%D0%B0%D0%B1%D0%BB%2028aeb7bb74098065891bc846b53aff14.md) — правила подтяжки значений из организации.
- [JSON-shema](../%D0%A0%D0%B5%D0%BA%D0%B2%D0%B8%D0%B7%D0%B8%D1%82%D1%8B%20%D0%B8%20%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20290eb7bb7409800cb033fe6f585d9f78/JSON-shema%2028aeb7bb740980ae995ff9b5c20b86de.md) / [Модуль проверки (JS)](%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%20%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8%20(%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D1%8B%D0%B9%20%D0%BA%D0%BE%D0%B4,%20JS)%20requisitesGuard%20%2028feb7bb7409805ab92ddac72668c178.md) — валидации и блокировки сабмита.
- [Мой архив документов](%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%C2%AB%D0%9C%D0%BE%D0%B9%20%D0%B0%D1%80%D1%85%D0%B8%D0%B2%20%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2%C2%BB%20(User)%2028feb7bb740980a58c4ac31e22acfd43.md) — куда попадает собранный файл.

---

## Вход и маршруты

- Из каталога **сразу**, если `hasBodyChat = Нет`.
- После «Тело документа — чат», если `hasBodyChat = Да`.
- Маршрут: `/doc/:docId/requisites`.

---

## Роли и доступ

- Только **пользователь** (владелец документа).

---

## Макет (desktop)

- Заголовок: **Заполнение реквизитов**
- Подзаголовок: `<Название шаблона> · <Версия>`
- Блок **Выбор организации**:
    - Select **«Организация»**: список организаций пользователя (+ «Не выбирать»).
    - Кнопка **Подтянуть реквизиты** (активна, если выбрана организация).
    - Пояснение: «Подтянем все доступные поля из выбранной организации. Изменения ниже влияют только на текущий документ».
- Раздел **Реквизиты для этого документа** (форма):
    - Поля — **строго** по привязке админа к шаблону.
    - Для каждого поля: label, input, подсказка/пример, inline-ошибка.
- Нижняя панель (sticky):
    - **Собрать и скачать (DOCX)** — primary
    - **Скачать PDF** — secondary
    - **Назад**:
        - если `hasBodyChat = Да` → «Назад к телу»
        - если `hasBodyChat = Нет` → «Назад к шаблонам»
    

---

## Поведение

1. **Подтянуть из организации (однократно по нажатию)**
- Берём **все доступные поля** из карточки организации (см. JSON-schema).
- Заполняем **только те**, что требуются текущим шаблоном (по привязке админа).
- Поля, отсутствующие у организации, остаются пустыми.
- Бизнес-правило: **подтягиваем всё возможное, без исключений**.
- Далее пользователь может **ручными правками** поменять любые значения в форме (это влияет только на текущий документ).
1. **Валидация**
- По **JSON-schema** (ссылка выше): ИНН/КПП/ОГРН(ИП), БИК/р/с/к/с, e-mail, телефон и т. п.
- Триггеры: onBlur (inline-ошибки) и onSubmit (блокирующая, скролл к первому ошибочному полю).
- Если `authority_base = "Доверенности"` → `poa_number` и `poa_date` обязательны (логика `if/then` в схеме).
1. **Сборка**
- **Собрать и скачать (DOCX)** / **Скачать PDF**:
    - Проверка валидности формы.
    - Сборка из `templateCode` + `templateVersion` + `bodyText` (если был чат) + `requisites` (значения формы).
    - Генерация файла на сервере/воркере и скачивание.

---

## Данные (что сохраняем в документ)

```json
{
  "docId": "<uuid>",
  "templateCode": "<string>",
  "templateVersion": "<semver>",
  "hasBodyChat": true,
  "bodyText": "<string|null>",
  "organizationId": "<uuid|null>",
  "requisites": { /* snapshot значений по JSON-schema, только поля, привязанные к шаблону */ },
  "createdAt": "<iso8601>",
  "createdBy": "<userId>"
}

```

> requisites — снимок на момент сборки; дальнейшие изменения в карточке организации на собранный файл не влияют.
> 

---

## Сигналы доступности

- **Подтянуть реквизиты** — активна, если выбрана организация.
- **Собрать и скачать (DOCX)** / **Скачать PDF** — активны, если все **обязательные** для этого шаблона поля валидны.
- **Назад** — всегда активна (маршрут зависит от `hasBodyChat`).

---

## Маршруты «Назад»

- Был чат: `/doc/:docId/body`
- Не было чата: `/templates/use/:templateCode`

---

## Критерии приёмки (QA)

1. Кнопка **«Подтянуть реквизиты»** переносит все возможные поля из выбранной организации, но в форме отображаются только **привязанные к шаблону**.
2. Ручная правка полей **не** изменяет карточку организации (только текущий документ).
3. Валидация строго соответствует **JSON-schema**; ошибки блокируют сборку.
4. DOCX/PDF собираются из (шаблон + версия) + (опционально тело) + реквизиты формы.
5. Кнопка **Назад** ведёт либо к чату, либо к карточке шаблона — в зависимости от `hasBodyChat`.
6. На странице **нет** ИИ-вызовов.