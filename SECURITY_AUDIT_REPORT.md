# üîí –ê–£–î–ò–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò: –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-01-28  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** Production-ready  
**–ê—É–¥–∏—Ç–æ—Ä:** Security Engineer

---

## üìã –ò–°–ü–û–õ–¨–ó–£–ï–ú–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ú–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–¢–∏–ø:** Email-based –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã (OTP) + JWT —Ç–æ–∫–µ–Ω—ã
- **Flow:** Email ‚Üí OTP –∫–æ–¥ ‚Üí JWT Access Token (15 –º–∏–Ω) + Refresh Token (7 –¥–Ω–µ–π)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤:** HTTP-only cookies (–±–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Ç XSS)
- **Middleware:** Next.js middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –≤—Å–µ—Ö API endpoints

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- **JWT –±–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `jsonwebtoken`
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL (Prisma ORM)
- **Rate limiting:** Upstash Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **Email –æ—Ç–ø—Ä–∞–≤–∫–∞:** Nodemailer (Gmail SMTP)

---

## ‚úÖ –ü–†–û–í–ï–†–ï–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´

### 1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| Middleware –∑–∞—â–∏—Ç–∞ API | ‚úÖ | –í—Å–µ `/api/*` –∑–∞—â–∏—â–µ–Ω—ã, –ø—É–±–ª–∏—á–Ω—ã–µ –ø—É—Ç–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è frontend-backend | ‚úÖ | Cookies –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å `credentials: 'include'` |
| –û—Ç–∫—Ä—ã—Ç—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã | ‚úÖ | –¢–æ–ª—å–∫–æ `/api/auth/*` –ø—É–±–ª–∏—á–Ω—ã–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã |

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå **–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh –ø—Ä–∏ 401** - —Å—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω, –ø–æ—Ç–µ—Ä—è —Å–µ—Å—Å–∏–∏
- ‚ö†Ô∏è **Rate limiting —Ç–æ–ª—å–∫–æ —Å Upstash** - –±–µ–∑ Redis rate limit –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (mock –≤ dev)

---

### 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥

#### –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ (`/api/auth/send-code`)

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| Rate limit | ‚ö†Ô∏è | –ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–æ —Ç–æ–ª—å–∫–æ —Å Upstash. –ë–µ–∑ Redis - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è |
| –í–∞–ª–∏–¥–∞—Ü–∏—è email | ‚úÖ | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —á–µ—Ä–µ–∑ regex |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ | ‚úÖ | 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, crypto.randomBytes –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |
| –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–¥–∞ | ‚úÖ | 10 –º–∏–Ω—É—Ç, –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö |
| –û—Ç–ø—Ä–∞–≤–∫–∞ email | ‚úÖ | –ß–µ—Ä–µ–∑ Nodemailer, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ |

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **‚ùå –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (User Enumeration)**
   ```typescript
   // src/app/api/auth/send-code/route.ts:26-33
   // –í–°–ï–ì–î–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç success=true, –¥–∞–∂–µ –µ—Å–ª–∏ email –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   return NextResponse.json({
     success: true,
     message: '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email',
     token: token,
   });
   ```
   **–†–∏—Å–∫:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ email –≤ —Å–∏—Å—Ç–µ–º–µ.
   **–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email.

2. **‚ö†Ô∏è –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ development**
   ```typescript
   // –°—Ç—Ä–æ–∫–∞ 93
   ...(process.env.NODE_ENV !== 'production' ? { code } : {})
   ```
   **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π, —Ç–∞–∫ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤ dev. –ù–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ production.

#### –®–∞–≥ 2: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞ (`/api/auth/verify-code`)

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| Rate limit | ‚ö†Ô∏è | –¢–æ—Ç –∂–µ issue - —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Upstash |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ | ‚úÖ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î, expiration, used —Ñ–ª–∞–≥ |
| Mark as used | ‚úÖ | –ö–æ–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π |
| –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | ‚úÖ | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —á–µ—Ä–µ–∑ `upsertUser` |
| –í—ã–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤ | ‚úÖ | Access + Refresh —Ç–æ–∫–µ–Ω—ã –≤ cookies |

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **‚ùå –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –æ—à–∏–±–∫–∞—Ö**
   ```typescript
   // src/app/api/auth/verify-code/route.ts:47-55
   if (!loginToken) {
     return NextResponse.json(
       { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –∫–æ–¥' },
       { status: 400 }
     );
   }
   ```
   **–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π, –Ω–æ –ª—É—á—à–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è ("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥").

2. **‚úÖ –•–æ—Ä–æ—à–æ:** –ù–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è "–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥" –∏ "–∫–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç", —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

### 3. –¢–æ–∫–µ–Ω—ã –∏ —Å–µ—Å—Å–∏–∏

#### Access Token

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|----------|--------|
| –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ | 15 –º–∏–Ω—É—Ç | ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π TTL |
| –•—Ä–∞–Ω–µ–Ω–∏–µ | HTTP-only cookie | ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS |
| SameSite | strict | ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF |
| Secure flag | –¢–æ–ª—å–∫–æ –≤ production | ‚úÖ |
| –ê–ª–≥–æ—Ä–∏—Ç–º | HS256 (JWT) | ‚úÖ |

#### Refresh Token

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|----------|--------|
| –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ | 7 –¥–Ω–µ–π | ‚úÖ –ê–¥–µ–∫–≤–∞—Ç–Ω—ã–π TTL |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î | ‚úÖ | –° —Ñ–ª–∞–≥–æ–º `revoked` |
| –†–æ—Ç–∞—Ü–∏—è | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ `ROTATE_REFRESH_TOKENS=true` |
| –•—Ä–∞–Ω–µ–Ω–∏–µ | HTTP-only cookie | ‚úÖ |
| –û—Ç–∑—ã–≤ –ø—Ä–∏ logout | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **‚ö†Ô∏è –†–æ—Ç–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**
   ```typescript
   // src/app/api/auth/refresh/route.ts:62
   const shouldRotateRefresh = process.env.ROTATE_REFRESH_TOKENS === 'true';
   ```
   **–†–∏—Å–∫:** –ï—Å–ª–∏ refresh —Ç–æ–∫–µ–Ω —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, –µ–≥–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è (7 –¥–Ω–µ–π).
   **–†–µ—à–µ–Ω–∏–µ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

2. **‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh –ø—Ä–∏ 401**
   ```typescript
   // src/lib/api-client.ts:18-28
   if (!response.ok) {
     if (typeof window !== 'undefined' && (response.status === 401 || response.status === 403)) {
       window.location.href = target; // –°—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç, –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ refresh
     }
   }
   ```
   **–†–∏—Å–∫:** –ü–ª–æ—Ö–æ–π UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç.
   **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å interceptor, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `/api/auth/refresh`.

3. **‚úÖ –•–æ—Ä–æ—à–æ:** Refresh —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `revoked` —Ñ–ª–∞–≥.

---

### 4. –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π

| –ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------------|--------|-------------|
| Middleware | ‚úÖ | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `payload.role` –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ `/api/admin/*` |
| Backend API routes | ‚úÖ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `getCurrentUser()` |
| –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ | ‚úÖ | Middleware + API route - —Ö–æ—Ä–æ—à–æ |

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// src/middleware.ts:135-142
if (ADMIN_PATHS.some(path => pathname.startsWith(path))) {
  if (payload.role !== 'admin') {
    return NextResponse.json(
      { error: 'Forbidden', message: 'Admin access required' },
      { status: 403 }
    );
  }
}
```

**‚úÖ –•–æ—Ä–æ—à–æ:** –†–æ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ –≤ middleware, –∏ –≤ –∫–∞–∂–¥–æ–º admin endpoint.

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. **‚ö†Ô∏è –†–æ–ª—å –≤ JWT –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –ë–î –ø—Ä–∏ refresh**
   ```typescript
   // src/app/api/auth/refresh/route.ts:44-51
   if (user.email !== payload.email || user.role !== payload.role) {
     await revokeRefreshToken(refreshTokenValue);
     return NextResponse.json(
       { error: 'Unauthorized', message: 'User data changed, please login again' },
       { status: 401 }
     );
   }
   ```
   **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ï—Å–ª–∏ —Ä–æ–ª—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –æ—Ç–∑—ã–≤–∞—é—Ç—Å—è.

---

### 5. –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

#### –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤

| –ö–æ–¥ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----|---------------|--------|
| 400 | –í–∞–ª–∏–¥–∞—Ü–∏—è | ‚úÖ |
| 401 | Unauthorized | ‚úÖ |
| 403 | Forbidden (—Ä–æ–ª—å) | ‚úÖ |
| 404 | Not Found | ‚úÖ |
| 409 | Conflict (email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | ‚úÖ |
| 429 | Rate Limit | ‚úÖ |
| 500 | Internal Error | ‚úÖ |

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **‚ö†Ô∏è Stack trace –≤ –æ—à–∏–±–∫–∞—Ö (—Ç–æ–ª—å–∫–æ –≤ dev)**
   ```typescript
   // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç —Å console.error –±–µ–∑ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏
   console.error('GET /api/users/me error:', error);
   ```
   **–†–∏—Å–∫:** –í production Next.js –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç stack trace –≤ –æ—Ç–≤–µ—Ç–∞—Ö, –Ω–æ –ª—É—á—à–µ —É–±–µ–¥–∏—Ç—å—Å—è.
   **–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–æ–ª—å–∫–æ `{ error: 'Internal server error' }` –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π.

2. **‚úÖ –•–æ—Ä–æ—à–æ:** –í –æ—Ç–≤–µ—Ç–∞—Ö API –Ω–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–æ–¥—ã, —Ç–æ–∫–µ–Ω—ã, –ø–∞—Ä–æ–ª–∏).

---

### 6. –õ–æ–≥–∏ –∏ –∞—É–¥–∏—Ç

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤ | ‚ùå | –ù–µ—Ç –ª–æ–≥–æ–≤ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤ |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ | ‚úÖ | Rate limit –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ Upstash |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ | ‚ùå | –ù–µ—Ç |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –ª–æ–≥–∞—Ö | ‚úÖ | –ü–∞—Ä–æ–ª–µ–π –Ω–µ—Ç (—Ç–æ–ª—å–∫–æ email –∫–æ–¥—ã) |
| –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ª–æ–≥–∞—Ö | ‚ö†Ô∏è | –í dev –µ—Å—Ç—å console.log —Å email, –Ω–æ –Ω–µ —Ç–æ–∫–µ–Ω—ã |

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. **‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
   - –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ (—Ö–æ—Ç—è –µ—Å—Ç—å `AccessHistory` –≤ –ë–î)
   - –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ 401, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π)

---

### 7. UX-–ø–æ–≤–µ–¥–µ–Ω–∏–µ

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ | ‚úÖ | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç—ë–∫—à–µ–≥–æ —Ç–æ–∫–µ–Ω–∞ | ‚ùå | –°—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç, –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ refresh |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout | ‚ùå | –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞ |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ | ‚ùå | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –ö–Ω–æ–ø–∫–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ | ‚úÖ | –ï—Å—Ç—å `disabled` —Å–æ—Å—Ç–æ—è–Ω–∏–µ |

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. **‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞**
   - –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ access token (15 –º–∏–Ω) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 401
   - –ö–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/auth/login`
   - –ù–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ refresh endpoint
   - **UX Impact:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å interceptor –≤ `api-client.ts`:
```typescript
// –ü—Å–µ–≤–¥–æ–∫–æ–¥ —Ä–µ—à–µ–Ω–∏—è
if (response.status === 401) {
  try {
    await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
    // –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    return apiClient(url, options);
  } catch {
    // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–∏ refresh - —Ä–µ–¥–∏—Ä–µ–∫—Ç
    window.location.href = '/auth/login';
  }
}
```

---

### 8. –£—è–∑–≤–∏–º–æ—Å—Ç–∏

#### XSS (Cross-Site Scripting)

| –ó–∞—â–∏—Ç–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| HTTP-only cookies | ‚úÖ | –¢–æ–∫–µ–Ω—ã –≤ HTTP-only cookies |
| Content Security Policy | ‚ùì | –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ |
| Input sanitization | ‚ö†Ô∏è | –ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |

#### CSRF (Cross-Site Request Forgery)

| –ó–∞—â–∏—Ç–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------|--------|-------------|
| SameSite=strict | ‚úÖ | Cookies —Å SameSite=strict |
| CSRF —Ç–æ–∫–µ–Ω—ã | ‚ùå | –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö CSRF —Ç–æ–∫–µ–Ω–æ–≤ |
| Referer –ø—Ä–æ–≤–µ—Ä–∫–∞ | ‚ùå | –ù–µ—Ç |

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. **‚ö†Ô∏è –¢–æ–ª—å–∫–æ SameSite –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF**
   - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç SameSite=strict
   - –ù–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ CSRF —Ç–æ–∫–µ–Ω—ã –±—ã–ª–∞ –±—ã –ª—É—á—à–µ
   - **–†–∏—Å–∫:** –°—Ä–µ–¥–Ω–∏–π (SameSite –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤)

#### Session Fixation

| –ó–∞—â–∏—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|--------|--------|
| –†–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ | ‚úÖ |
| –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ | ‚úÖ |

**‚úÖ –•–æ—Ä–æ—à–æ:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã.

#### Token Storage

| –ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------------|--------|-------------|
| localStorage | ‚ùå | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| sessionStorage | ‚ùå | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| HTTP-only cookies | ‚úÖ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| Memory | ‚úÖ | React Query –∫–µ—à (—Ç–æ–ª—å–∫–æ user data) |

**‚úÖ –û—Ç–ª–∏—á–Ω–æ:** –¢–æ–∫–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ HTTP-only cookies, –Ω–µ –≤ localStorage.

#### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º

| –ü–æ–ª–µ | –í–∞–ª–∏–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|------|-----------|--------|
| Email | Regex | ‚úÖ |
| –ö–æ–¥ | 6 —Ü–∏—Ñ—Ä | ‚úÖ |
| –î—Ä—É–≥–∏–µ –ø–æ–ª—è | Zod schemas | ‚úÖ |

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –†–∏—Å–∫ |
|-----------|----------|--------|-------------------|
| **–¢–æ–∫–µ–Ω—ã** | Access token TTL | ‚úÖ | 15 –º–∏–Ω—É—Ç - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| **–¢–æ–∫–µ–Ω—ã** | Refresh token TTL | ‚úÖ | 7 –¥–Ω–µ–π - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| **–¢–æ–∫–µ–Ω—ã** | –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ HTTP-only | ‚úÖ | –ó–∞—â–∏—Ç–∞ –æ—Ç XSS |
| **–¢–æ–∫–µ–Ω—ã** | Refresh flow | ‚ùå | –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh –ø—Ä–∏ 401 |
| **–¢–æ–∫–µ–Ω—ã** | –†–æ—Ç–∞—Ü–∏—è refresh | ‚ö†Ô∏è | –í—ã–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| **–¢–æ–∫–µ–Ω—ã** | –û—Ç–∑—ã–≤ –ø—Ä–∏ logout | ‚úÖ | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| **–†–æ–ª–∏** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ backend | ‚úÖ | Middleware + API route |
| **–†–æ–ª–∏** | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ë–î | ‚úÖ | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ refresh |
| **–û—à–∏–±–∫–∏** | –°–æ–æ–±—â–µ–Ω–∏—è login | ‚ùå | –£—Ç–µ—á–∫–∞: –≤—Å–µ–≥–¥–∞ success, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ email |
| **–û—à–∏–±–∫–∏** | –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã |
| **–û—à–∏–±–∫–∏** | Stack trace | ‚ö†Ô∏è | –í dev –µ—Å—Ç—å, –≤ prod - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Next.js |
| **Rate Limit** | –î–ª—è auth | ‚ö†Ô∏è | –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Upstash |
| **Rate Limit** | –î–ª—è API | ‚ö†Ô∏è | –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Upstash |
| **CSRF** | SameSite=strict | ‚úÖ | –•–æ—Ä–æ—à–∞—è –∑–∞—â–∏—Ç–∞ |
| **CSRF** | CSRF —Ç–æ–∫–µ–Ω—ã | ‚ùå | –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã |
| **XSS** | HTTP-only cookies | ‚úÖ | –ó–∞—â–∏—â–µ–Ω–æ |
| **–õ–æ–≥–∏** | –ê—É–¥–∏—Ç –≤—Ö–æ–¥–æ–≤ | ‚ùå | –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è |
| **UX** | –ê–≤—Ç–æ-refresh | ‚ùå | –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ |

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π)

1. **‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞**
   - **–í–ª–∏—è–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å interceptor –≤ `api-client.ts`

2. **‚ùå User Enumeration –≤ `/api/auth/send-code`**
   - **–í–ª–∏—è–Ω–∏–µ:** –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ email –≤ —Å–∏—Å—Ç–µ–º–µ
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç

---

## ‚ö†Ô∏è –°–†–ï–î–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π)

1. **‚ö†Ô∏è Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Upstash**
   - **–í–ª–∏—è–Ω–∏–µ:** –í dev/staging –±–µ–∑ Redis rate limit –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å in-memory rate limiter –∫–∞–∫ fallback

2. **‚ö†Ô∏è –†–æ—Ç–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞**
   - **–í–ª–∏—è–Ω–∏–µ:** –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç 7 –¥–Ω–µ–π
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í–∫–ª—é—á–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –æ–ø—Ç-out

3. **‚ö†Ô∏è –ù–µ—Ç –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
   - **–í–ª–∏—è–Ω–∏–µ:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)
1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ 401
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å user enumeration –≤ send-code
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å in-memory rate limiter –∫–∞–∫ fallback

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)
1. ‚úÖ –í–∫–ª—é—á–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é refresh —Ç–æ–∫–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç CSRF —Ç–æ–∫–µ–Ω–∞–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏—è)
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Content Security Policy headers
2. ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ 401, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π)

---

## ‚úÖ –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –•–û–†–û–®–û

1. ‚úÖ **HTTP-only cookies** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS
2. ‚úÖ **SameSite=strict** - –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF
3. ‚úÖ **–ö–æ—Ä–æ—Ç–∫–∏–π TTL access token** - 15 –º–∏–Ω—É—Ç
4. ‚úÖ **–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π** - middleware + API route
5. ‚úÖ **Refresh —Ç–æ–∫–µ–Ω—ã –≤ –ë–î** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–∞
6. ‚úÖ **Rate limiting** - –µ—Å—Ç—å (–Ω–æ —Ç–æ–ª—å–∫–æ —Å Upstash)
7. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod** - —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
8. ‚úÖ **–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** ‚ö†Ô∏è **75/100** (–•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)

–°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –±–∞–∑–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (HTTP-only cookies)
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π TTL access token
- ‚úÖ Refresh —Ç–æ–∫–µ–Ω—ã —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∑—ã–≤–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π –Ω–∞ backend

**–ù–æ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞ (–ø–ª–æ—Ö–æ–π UX)
- ‚ùå User enumeration —É—è–∑–≤–∏–º–æ—Å—Ç—å
- ‚ö†Ô∏è Rate limiting –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–¥ production deployment.

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–∞
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å user enumeration
3. –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è rate limiting
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏ refresh —Ç–æ–∫–µ–Ω–æ–≤












